[env]
PROFILES_DIR = "profiles"

[tasks.check_env]
description = "環境変数がちゃんと設定されているか確認する"
quiet = true
hide = true
shell = "bash -c"
run = """
set -eu
if [ ! -e "{{env.MISE_CONFIG_ROOT}}/mise.local.toml" ]; then
  {
    printf "%s\n" '[env]'
    printf "%s\n" 'DEFAULT_CLAUDE_PROFILE=""'
  } > "{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
  printf "%s\n" "🚨 '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' に環境変数を設定する必要があります。"
  printf "%s\n" "🚨 必要な環境変数をデフォルトでセットしました。"
  printf "%s\n" "🚨 DEFAULT_CLAUDE_PROFILE=\"\" に適切なプロファイル名を設定してください。"
  exit 1
fi
if [ -z "${DEFAULT_CLAUDE_PROFILE:-}" ]; then
  printf "%s\n" "🚨 'DEFAULT_CLAUDE_PROFILE' を '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' に設定してください。"
  exit 1
fi

# ~/.claude ディレクトリが存在しない場合は作成
if [ ! -d "${HOME}/.claude" ]; then
  mkdir -p "${HOME}/.claude"
fi
"""

[tasks.check]
description = "指定プロファイルが存在するかを確認し、なければエラーを返す"
depends = ["check_env"]
hide = true
quiet = true
shell = "bash -c"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_CLAUDE_PROFILE)}}
if [ -z "$PROFILE" ]; then
  printf "❌ Error: DEFAULT_CLAUDE_PROFILE is not set in environment variables\n" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

if [ ! -d "$PROFILE_PATH" ]; then
  {
    printf "❌ Error: Profile directory '$PROFILE_PATH' does not exist\n"
    printf "   Available profiles:\n"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      printf "   (No profiles directory found)\n"
    fi
  } >&2
  exit 1
fi
"""

[tasks.create_profile]
description = "新しいプロファイルを作成 (Usage: mise run create_profile <profile-name>)"
depends = ["check_env"]
shell = "bash -c"
run = """
PROFILE={{arg(name="prof")}}
if [ -z "$PROFILE" ]; then
  {
    printf "❌ Error: profile name is required.\n"
    printf "   Usage: mise run create_profile <profile-name>\n"
  } >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
if [ -d "$PROFILE_PATH" ]; then
  printf "❌ Error: Profile '$PROFILE' already exists\n" >&2
  exit 1
fi

printf "🦄 Creating new Claude profile: $PROFILE\n"
mkdir -p "$PROFILE_PATH"

# デフォルト設定ファイル作成
cat > "$PROFILE_PATH/settings.json" << 'EOF'
{
  "permissions": {
    "allow": [
      "Bash(mkdir:*)",
      "Bash(touch:*)",
      "Bash(ls:*)",
      "Bash(cat:*)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm -rf:*)",
      "Read(.env:*)",
      "Read(**/*token*)",
      "Read(**/secrets/**)"
    ],
    "defaultMode": "acceptEdits"
  },
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "afplay /System/Library/Sounds/Glass.aiff"
          }
        ]
      }
    ]
  }
}
EOF

cat > "$PROFILE_PATH/settings.local.json" << 'EOF'
{
  "permissions": {
    "allow": [],
    "deny": [],
    "ask": [],
    "defaultMode": "acceptEdits"
  }
}
EOF

cat > "$PROFILE_PATH/CLAUDE.md" << 'EOF'
# Claude Instructions for this Profile

## Project Context
<!-- Describe the type of projects this profile is used for -->

## Preferred Tools and Libraries
<!-- List commonly used tools, frameworks, or libraries for this environment -->

## Code Style Guidelines
<!-- Specify any coding standards or preferences -->

## Environment-Specific Notes
<!-- Add any machine-specific or environment-specific instructions -->

## Restrictions
<!-- Note any specific restrictions or security considerations -->
EOF

# commands ディレクトリ作成
mkdir -p "$PROFILE_PATH/commands"

printf "%s\n" "✅ Created profile '$PROFILE' at $PROFILE_PATH"
printf "%s\n" "📝 Edit settings in:"
printf "%s\n" "   - $PROFILE_PATH/settings.json"
printf "%s\n" "   - $PROFILE_PATH/settings.local.json"
printf "%s\n" "   - $PROFILE_PATH/CLAUDE.md"
printf "%s\n" "   - $PROFILE_PATH/commands/"
"""

[tasks.link]
description = "指定プロファイルの設定ファイルをシンボリックリンクする"
depends = ["check_env"]
shell = "bash -c"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_CLAUDE_PROFILE)}}
mise run check --prof "$PROFILE"

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

printf "%s\n" "🦄 Linking Claude settings from profile: $PROFILE"

# 既存のシンボリックリンクを削除（ファイルの場合は退避）
for file in settings.json settings.local.json CLAUDE.md; do
  target="${HOME}/.claude/$file"
  if [ -L "$target" ]; then
    printf "%s\n" "   Removing existing symlink: $target"
    rm "$target"
  elif [ -f "$target" ]; then
    backup="${target}.backup.$(date +%Y%m%d_%H%M%S)"
    printf "%s\n" "   既存のファイルをバックアップしました: $target -> $backup"
    mv "$target" "$backup"
  fi
done

# commands ディレクトリの処理
commands_target="${HOME}/.claude/commands"
if [ -L "$commands_target" ]; then
  printf "%s\n\n" "   Removing existing symlink: $commands_target"
  rm "$commands_target"
elif [ -d "$commands_target" ]; then
  backup="${commands_target}.backup.$(date +%Y%m%d_%H%M%S)"
  printf "%s\n\n" "   既存のディレクトリをバックアップしました: $commands_target -> $backup"
  mv "$commands_target" "$backup"
fi

# シンボリックリンク作成
printf "\\033[36m"
for file in settings.json settings.local.json CLAUDE.md; do
  source="$PROFILE_PATH/$file"
  target="${HOME}/.claude/$file"

  if [ -f "$source" ]; then
    ln -sfv "$source" "$target"
  fi
done

# commands ディレクトリのシンボリックリンク作成
commands_source="$PROFILE_PATH/commands"
if [ -d "$commands_source" ]; then
  ln -sfv "$commands_source" "$commands_target"
fi
printf "\\033[0m"

printf "%s\n" "✅ Linked Claude settings from profile '$PROFILE'"
"""

[tasks.status]
description = "現在のプロファイル設定と~/.claudeの状態を確認"
depends = ["check_env"]
shell = "bash -c"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_CLAUDE_PROFILE)}}
PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

printf "%s\n" "🦄 Claude Profile Status"
printf "Current profile:\\033[36m $PROFILE\\033[0m\n"
printf "Profile path:\\033[36m $PROFILE_PATH\\033[0m\n\n"

if [ ! -d "$PROFILE_PATH" ]; then
  printf "%s\n" "❌ Profile directory does not exist"
  exit 1
fi

printf "%s\n" "📂 Profile files:"
for file in settings.json settings.local.json CLAUDE.md; do
  source="$PROFILE_PATH/$file"
  if [ -f "$source" ]; then
    printf "%s\n" "   ✅ $file"
  else
    printf "%s\n" "   ❌ $file (missing)"
  fi
done

commands_source="$PROFILE_PATH/commands"
if [ -d "$commands_source" ]; then
  printf "%s\n" "   ✅ commands/"
else
  printf "%s\n" "   ❌ commands/ (missing)"
fi

printf "%s" "\n🔗 Symlink status in"
printf "\\033[36m ~/.claude:\\033[0m\n"
for file in settings.json settings.local.json CLAUDE.md; do
  target="${HOME}/.claude/$file"
  source="$PROFILE_PATH/$file"

  if [ -L "$target" ]; then
    link_target=$(readlink "$target")
    # Windows環境でも動くように、より柔軟な方法でマッチング
    if [ "$link_target" = "$source" ] || [[ "$link_target" == */"${source##*/}" ]]; then
      printf "%s\n" "   ✅ $file -> $source"
    else
      printf "%s\n" "   ⚠️  $file -> $link_target (不一致)"
    fi
  elif [ -f "$target" ]; then
    printf "%s\n" "   ❌ $file (通常ファイル、シンボリックリンクではない)"
  else
    printf "%s\n" "   ❌ $file (存在しない)"
  fi
done

# commands ディレクトリの状態確認
commands_target="${HOME}/.claude/commands"
commands_source="$PROFILE_PATH/commands"

if [ -L "$commands_target" ]; then
  link_target=$(readlink "$commands_target")
  # Windows環境でも動くように、より柔軟な方法でマッチング
  if [ "$link_target" = "$commands_source" ] || [[ "$link_target" == */"${commands_source##*/}" ]]; then
    printf "%s\n" "   ✅ commands/ -> $commands_source"
  else
    printf "%s\n" "   ⚠️  commands/ -> $link_target (不一致)"
  fi
elif [ -d "$commands_target" ]; then
  printf "%s\n" "   ❌ commands/ (通常ディレクトリ、シンボリックリンクではない)"
else
  printf "%s\n" "   ❌ commands/ (存在しない)"
fi

printf "%s\n" "\n💡 Commands:"
printf "%s\n" "   リンク作成/更新: mise run link --prof \"$PROFILE\""
printf "%s\n" "   プロファイル変更: mise run switch <profile-name>"
"""

[tasks.switch]
description = "プロファイルを切り替えてシンボリックリンクを更新 (Usage: mise run switch <profile-name>)"
depends = ["check_env"]
shell = "bash -c"
run = """
NEW_PROFILE={{arg(name="prof")}}
if [ -z "$NEW_PROFILE" ]; then
  {
    printf "%s\n" "❌ Error: profile name is required."
    printf "%s\n" "   Usage: mise run switch <profile-name>\n"
    printf "%s\n" "   Available profiles:"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/     - /'
    fi
  } >&2
  exit 1
fi

# プロファイル存在確認
mise run check --prof "$NEW_PROFILE"

# mise.local.toml の DEFAULT_CLAUDE_PROFILE を更新
LOCAL_CONFIG="{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
{
  printf "%s\n" '[env]'
  printf "%s\n" "DEFAULT_CLAUDE_PROFILE = \\\"$NEW_PROFILE\\\""
} > "$LOCAL_CONFIG"

printf "%s\n" "🦄 Switching Claude profile to: $NEW_PROFILE"

# シンボリックリンクを更新
mise run link --prof "$NEW_PROFILE"

printf "%s\n" "✅ Switched to profile '$NEW_PROFILE'"
printf "%s\n" "🔄 Please restart your shell or run 'mise env' to reload environment variables"
"""

[tasks.list]
description = "利用可能なプロファイル一覧を表示"
depends = ["check_env"]
shell = "bash -c"
run = """
PROFILES_DIR="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}"
CURRENT_PROFILE="${DEFAULT_CLAUDE_PROFILE:-}"

printf "%s\n" "🦄 Available Claude Profiles:"
if [ -d "$PROFILES_DIR" ]; then
  for profile in "$PROFILES_DIR"/*; do
    if [ -d "$profile" ]; then
      profile_name=$(basename "$profile")
      if [ "$profile_name" = "$CURRENT_PROFILE" ]; then
        printf "%s\n" "   ✅ $profile_name (current)"
      else
        printf "%s\n" "   ⭕ $profile_name"
      fi
    fi
  done
else
  printf "%s\n" "   (No profiles found)"
fi

if [ -n "$CURRENT_PROFILE" ]; then
  printf "\nCurrent profile: $CURRENT_PROFILE\n"
else
  printf "\n⚠️ No current profile set in DEFAULT_CLAUDE_PROFILE\n"
fi
"""
