[env]
PROFILES_DIR="profiles"

[tasks.check_env]
description = "ç’°å¢ƒå¤‰æ•°ãŒã¡ã‚ƒã‚“ã¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹"
quiet = true
hide = true
run = """
set -eu
if [ ! -e "{{env.MISE_CONFIG_ROOT}}/mise.local.toml" ]; then
  {
    echo '[env]'
    echo 'DEFAULT_CLAUDE_PROFILE=""'
  } > "{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
  echo "ğŸš¨ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
  echo "ğŸš¨ å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"
  echo "ğŸš¨ DEFAULT_CLAUDE_PROFILE=\"\" ã«é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
if [ -z "${DEFAULT_CLAUDE_PROFILE:-}" ]; then
  echo "ğŸš¨ 'DEFAULT_CLAUDE_PROFILE' ã‚’ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi

# ~/.claude ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if [ ! -d "${HOME}/.claude" ]; then
  mkdir -p "${HOME}/.claude"
fi
"""

[tasks.check]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
depends = ["check_env"]
hide = true
quiet = true
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_CLAUDE_PROFILE)}}
if [ -z "$PROFILE" ]; then
  echo "âŒ Error: DEFAULT_CLAUDE_PROFILE is not set in environment variables" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

if [ ! -d "$PROFILE_PATH" ]; then
  {
    echo "âŒ Error: Profile directory '$PROFILE_PATH' does not exist"
    echo "   Available profiles:"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      echo "   (No profiles directory found)"
    fi
  } >&2
  exit 1
fi
"""

[tasks.create_profile]
description = "æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ (Usage: mise run create_profile <profile-name>)"
depends = ["check_env"]
run = """
PROFILE={{arg(name="prof")}}
if [ -z "$PROFILE" ]; then
  {
    echo "âŒ Error: profile name is required."
    echo "   Usage: mise run create_profile <profile-name>"
  } >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
if [ -d "$PROFILE_PATH" ]; then
  echo "âŒ Error: Profile '$PROFILE' already exists" >&2
  exit 1
fi

echo "ğŸ¦„ Creating new Claude profile: $PROFILE"
mkdir -p "$PROFILE_PATH"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cat > "$PROFILE_PATH/settings.json" << 'EOF'
{
  "permissions": {
    "allow": [
      "Bash(mkdir:*)",
      "Bash(touch:*)",
      "Bash(ls:*)",
      "Bash(cat:*)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm -rf:*)",
      "Read(.env:*)",
      "Read(**/*token*)",
      "Read(**/secrets/**)"
    ],
    "defaultMode": "acceptEdits"
  },
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "afplay /System/Library/Sounds/Glass.aiff"
          }
        ]
      }
    ]
  }
}
EOF

cat > "$PROFILE_PATH/settings.local.json" << 'EOF'
{
  "permissions": {
    "allow": [],
    "deny": [],
    "ask": [],
    "defaultMode": "acceptEdits"
  }
}
EOF

cat > "$PROFILE_PATH/CLAUDE.md" << 'EOF'
# Claude Instructions for this Profile

## Project Context
<!-- Describe the type of projects this profile is used for -->

## Preferred Tools and Libraries
<!-- List commonly used tools, frameworks, or libraries for this environment -->

## Code Style Guidelines
<!-- Specify any coding standards or preferences -->

## Environment-Specific Notes
<!-- Add any machine-specific or environment-specific instructions -->

## Restrictions
<!-- Note any specific restrictions or security considerations -->
EOF

echo "âœ… Created profile '$PROFILE' at $PROFILE_PATH"
echo "ğŸ“ Edit settings in:"
echo "   - $PROFILE_PATH/settings.json"
echo "   - $PROFILE_PATH/settings.local.json"
echo "   - $PROFILE_PATH/CLAUDE.md"
"""

[tasks.link]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã™ã‚‹"
depends = ["check_env"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_CLAUDE_PROFILE)}}
mise run check --prof "$PROFILE"

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

echo "ğŸ¦„ Linking Claude settings from profile: $PROFILE"

# æ—¢å­˜ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯é€€é¿ï¼‰
for file in settings.json settings.local.json CLAUDE.md; do
  target="${HOME}/.claude/$file"
  if [ -L "$target" ]; then
    echo "   Removing existing symlink: $target"
    rm "$target"
  elif [ -f "$target" ]; then
    backup="${target}.backup.$(date +%Y%m%d_%H%M%S)"
    echo "   æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ: $target -> $backup"
    mv "$target" "$backup"
  fi
done

# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ
for file in settings.json settings.local.json CLAUDE.md; do
  source="$PROFILE_PATH/$file"
  target="${HOME}/.claude/$file"

  if [ -f "$source" ]; then
    ln -sfv "$source" "$target"
  fi
done

echo "âœ… Linked Claude settings from profile '$PROFILE'"
"""

[tasks.status]
description = "ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã¨~/.claudeã®çŠ¶æ…‹ã‚’ç¢ºèª"
depends = ["check_env"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_CLAUDE_PROFILE)}}
PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

echo "ğŸ¦„ Claude Profile Status"
echo "Current profile: $PROFILE"
echo "Profile path: $PROFILE_PATH"
echo ""

if [ ! -d "$PROFILE_PATH" ]; then
  echo "âŒ Profile directory does not exist"
  exit 1
fi

echo "ğŸ“‚ Profile files:"
for file in settings.json settings.local.json CLAUDE.md; do
  source="$PROFILE_PATH/$file"
  if [ -f "$source" ]; then
    echo "   âœ… $file"
  else
    echo "   âŒ $file (missing)"
  fi
done

echo ""
echo "ğŸ”— Symlink status in ~/.claude:"
for file in settings.json settings.local.json CLAUDE.md; do
  target="${HOME}/.claude/$file"
  source="$PROFILE_PATH/$file"

  if [ -L "$target" ]; then
    link_target=$(readlink "$target")
    if [ "$link_target" = "$source" ]; then
      echo "   âœ… $file -> $source"
    else
      echo "   âš ï¸  $file -> $link_target (ä¸ä¸€è‡´)"
    fi
  elif [ -f "$target" ]; then
    echo "   âŒ $file (é€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§ã¯ãªã„)"
  else
    echo "   âŒ $file (å­˜åœ¨ã—ãªã„)"
  fi
done

echo ""
echo "ğŸ’¡ Commands:"
echo "   ãƒªãƒ³ã‚¯ä½œæˆ/æ›´æ–°: mise run link --prof \"$PROFILE\""
echo "   ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´: mise run switch <profile-name>"
"""

[tasks.switch]
description = "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’æ›´æ–° (Usage: mise run switch <profile-name>)"
depends = ["check_env"]
run = """
NEW_PROFILE={{arg(name="prof")}}
if [ -z "$NEW_PROFILE" ]; then
  {
    echo "âŒ Error: profile name is required."
    echo "   Usage: mise run switch <profile-name>"
    echo ""
    echo "   Available profiles:"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/     - /'
    fi
  } >&2
  exit 1
fi

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
mise run check --prof "$NEW_PROFILE"

# mise.local.toml ã® DEFAULT_CLAUDE_PROFILE ã‚’æ›´æ–°
LOCAL_CONFIG="{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
if [ -f "$LOCAL_CONFIG" ]; then
  # DEFAULT_CLAUDE_PROFILEè¡Œã‚’æ›´æ–°
  if grep -q "^DEFAULT_CLAUDE_PROFILE=" "$LOCAL_CONFIG"; then
    sed -i.bak "s/^DEFAULT_CLAUDE_PROFILE=.*/DEFAULT_CLAUDE_PROFILE=\"$NEW_PROFILE\"/" "$LOCAL_CONFIG"
    rm -f "$LOCAL_CONFIG.bak"
  else
    echo "DEFAULT_CLAUDE_PROFILE=\"$NEW_PROFILE\"" >> "$LOCAL_CONFIG"
  fi
else
  {
    echo '[env]'
    echo "DEFAULT_CLAUDE_PROFILE=\"$NEW_PROFILE\""
  } > "$LOCAL_CONFIG"
fi

echo "ğŸ¦„ Switching Claude profile to: $NEW_PROFILE"

# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
mise run link --prof "$NEW_PROFILE"

echo "âœ… Switched to profile '$NEW_PROFILE'"
echo "ğŸ”„ Please restart your shell or run 'mise env' to reload environment variables"
"""

[tasks.list]
description = "åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º"
depends = ["check_env"]
run = """
PROFILES_DIR="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}"
CURRENT_PROFILE="${DEFAULT_CLAUDE_PROFILE:-}"

echo "ğŸ¦„ Available Claude Profiles:"
if [ -d "$PROFILES_DIR" ]; then
  for profile in "$PROFILES_DIR"/*; do
    if [ -d "$profile" ]; then
      profile_name=$(basename "$profile")
      if [ "$profile_name" = "$CURRENT_PROFILE" ]; then
        echo "   âœ… $profile_name (current)"
      else
        echo "   â­• $profile_name"
      fi
    fi
  done
else
  echo "   (No profiles found)"
fi

if [ -n "$CURRENT_PROFILE" ]; then
  echo ""
  echo "Current profile: $CURRENT_PROFILE"
else
  echo ""
  echo "âš ï¸ No current profile set in DEFAULT_CLAUDE_PROFILE"
fi
"""
