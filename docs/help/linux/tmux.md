# tmux

## 概要

- ターミナルマルチプレクサ(Terminal Multiplexer) の略です。
- ターミナルを終了してもセッションは維持されます。コマンドを実行して翌日の朝結果を確認しようとしたら SSH ログアウトしてしまっていたという悲劇を避けることができます。
- Linux 系のターミナル画面を複数のセッション、ウィンドウ、ペインに分割して利用できます。

## インストール

```bash
brew install tmux  # macOS
sudo apt install tmux  # Debian/Ubuntu 系
sudo dnf install tmux  # RHEL/CentOS 系
sudo pacman -S tmux    # Arch Linux 系
```

## バージョンを確認する

```bash
tmux -V # 大文字のV
```

## セッション・ウィンドウ・ペインの概念

tmux は以下の3階層構造で構成されています。

```plain
tmux サーバー
└── セッション (Session)
    └── ウィンドウ (Window)
        └── ペイン (Pane)
```

### セッション (Session)

- tmux の最上位の単位
- SSH接続が切れてもセッションは維持される
  - PCとの接続を切ったり（デタッチ）、ターミナルを閉じたりしても、バックグラウンドで動き続ける
- 複数のプロジェクトごとにセッションを分けて管理できる

### ウィンドウ (Window)

- セッション内で複数持つことができる
- ブラウザのタブのようなイメージ
- 画面下部のステータスバーに 0,1,2... と番号で表示される

### ペイン (Pane)

- ウィンドウを上下・左右に分割した領域
- 1つの画面で複数のターミナルを同時に表示できる
- ログを監視しながら作業するなど、画面を分割して複数の情報を同時に見たい場合に便利

### ステータスバー

tmux を起動すると、画面下部に緑色のステータスバーが表示されます。

```plain
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                       ターミナル画面                            │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│[session] 0:bash  1:vim*  2:logs-                "host" 12:34 56│
└─────────────────────────────────────────────────────────────────┘
    ↑           ↑                                       ↑
   左側        中央                                    右側
```

| 位置 | 表示内容                                     |
| ---- | -------------------------------------------- |
| 左側 | セッション名（`[0]` や `[work]` など）       |
| 中央 | ウィンドウ一覧（`番号:名前` の形式で表示）   |
| 右側 | ホスト名、日付、時刻（デフォルト設定の場合） |

ウィンドウ一覧の記号：

| 記号 | 意味                                   |
| ---- | -------------------------------------- |
| `*`  | 現在アクティブなウィンドウ             |
| `-`  | 直前にいたウィンドウ                   |
| `#`  | ウィンドウの内容が変更された（監視時） |
| `!`  | ベルが鳴った                           |

ステータスバーを見れば、今どのセッションの何番目のウィンドウにいるかが一目で分かります。

### ペインタイトル

各ペインには識別用の「ペインタイトル」を設定できます。複数のペインで並行作業する際に、それぞれの役割を区別するのに便利です。

```plain
┌─ tmux セッション ──────────────────────────────────────────┐
│ [セッション名]                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ペイン1 (pane_title: "API Server")                         │
│  $ npm run dev                                              │
│  Server listening on port 8000...                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ペイン2 (pane_title: "Logs")                               │
│  $ tail -f app.log                                          │
│  [INFO] Request processed...                                │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ [0] 0:zsh*  │ ... │              "Logs" 15:34 02-Feb-26     │
│                                     ↑                       │
│                        現在アクティブなペインのタイトル      │
└─────────────────────────────────────────────────────────────┘
```

| 項目           | 内容                                               |
| :------------- | :------------------------------------------------- |
| ペインタイトル | 各ペインに付けられる識別用の文字列                 |
| デフォルト値   | ホスト名                                           |
| 表示場所       | ステータスバー右側（デフォルト設定の場合）         |
| 変更方法       | `tmux select-pane -T "タイトル"`                   |
| 自動更新       | vim, htop などのアプリが自動的に変更することがある |

ペインタイトルの設定：

```bash
# 現在のペインにタイトルを設定
tmux select-pane -T "API Server"

# PREFIX : でコマンドモードに入って設定
:select-pane -T "Logs"
```

## プレフィックスキー

tmux の操作は **プレフィックスキー + 何かのキー** の組み合わせで行います。

デフォルトのプレフィックスキーは **`Ctrl + b`** です。

例えば「新しいウィンドウを作成する」場合：

1. `Ctrl + b` を押す（離す）
2. `c` を押す

本ドキュメントでは `Ctrl + b` を `PREFIX` と表記します。

## 基本操作

### セッション操作

| コマンド / キーバインド             | 説明                                    |
| ----------------------------------- | --------------------------------------- |
| `tmux`                              | 新規セッションを開始                    |
| `tmux new -s セッション名`          | 名前付きセッションを作成                |
| `tmux ls`                           | セッション一覧を表示                    |
| `tmux a` または `tmux attach`       | 直前のセッションに復帰                  |
| `tmux a -t セッション名`            | 指定セッションに復帰                    |
| `tmux kill-session -t セッション名` | セッションを終了                        |
| `tmux kill-server`                  | tmux サーバーを停止（全セッション終了） |
| `PREFIX d`                          | セッションをデタッチ（切り離し）        |
| `PREFIX s`                          | セッション一覧から選択                  |
| `PREFIX $`                          | セッション名を変更                      |

### ウィンドウ操作

| キーバインド  | 説明                           |
| ------------- | ------------------------------ |
| `PREFIX c`    | 新規ウィンドウを作成           |
| `PREFIX n`    | 次のウィンドウに移動           |
| `PREFIX p`    | 前のウィンドウに移動           |
| `PREFIX 数字` | 指定した番号のウィンドウに移動 |
| `PREFIX w`    | ウィンドウ一覧から選択         |
| `PREFIX ,`    | ウィンドウ名を変更             |
| `PREFIX &`    | ウィンドウを強制終了           |

### ペイン操作

| キーバインド      | 説明                           |
| ----------------- | ------------------------------ |
| `PREFIX "`        | 上下に分割（横線で分割）       |
| `PREFIX %`        | 左右に分割（縦線で分割）       |
| `PREFIX 矢印キー` | 指定方向のペインに移動         |
| `PREFIX o`        | 次のペインに移動               |
| `PREFIX z`        | ペインを最大化/元に戻す        |
| `PREFIX !`        | ペインを新しいウィンドウにする |
| `PREFIX x`        | ペインを強制終了               |
| `PREFIX q`        | ペイン番号を表示               |
| `PREFIX {`        | ペインを前の位置と入れ替え     |
| `PREFIX }`        | ペインを次の位置と入れ替え     |

### コピーモード

#### コピーモードとは

tmux 内では通常のターミナルのようにマウスでスクロールしたり、テキストを選択してコピーすることができません。代わりに**コピーモード**という特別なモードを使います。

コピーモードでできること：

- 画面を上下にスクロールして過去の出力を確認する
- テキストを選択してコピーする
- 文字列を検索する

#### コピーモードの基本操作

| キーバインド | 説明                     |
| ------------ | ------------------------ |
| `PREFIX [`   | コピーモードを開始       |
| `PREFIX ]`   | バッファの内容を貼り付け |

#### コピーモード中の操作

デフォルトでは emacs 風のキーバインドですが、`.tmux.conf` で `setw -g mode-keys vi` を設定すると vi 風になります。

**vi モードの場合：**

| キー       | 説明                        |
| ---------- | --------------------------- |
| `h/j/k/l`  | カーソル移動（左/下/上/右） |
| `Ctrl+u/d` | 半ページ上/下にスクロール   |
| `Ctrl+b/f` | 1ページ上/下にスクロール    |
| `g`        | 先頭行に移動                |
| `G`        | 最終行に移動                |
| `Space`    | 選択開始                    |
| `Enter`    | 選択終了・コピー            |
| `/`        | 下方向に検索                |
| `?`        | 上方向に検索                |
| `n`        | 次の検索結果                |
| `N`        | 前の検索結果                |
| `q`        | コピーモード終了            |

**emacs モードの場合（デフォルト）：**

| キー              | 説明                   |
| ----------------- | ---------------------- |
| `↑/↓/←/→`         | カーソル移動           |
| `Ctrl+↑/↓`        | 1行ずつスクロール      |
| `PageUp/PageDown` | ページ単位でスクロール |
| `Ctrl+Space`      | 選択開始               |
| `Alt+w`           | 選択終了・コピー       |
| `Ctrl+s`          | 下方向に検索           |
| `Ctrl+r`          | 上方向に検索           |
| `Escape`          | コピーモード終了       |

#### コピー＆ペーストの流れ

1. `PREFIX [` でコピーモード開始
2. `h/j/k/l` でコピーしたい位置に移動
3. `Space` で選択開始
4. `h/j/k/l` で選択範囲を広げる
5. `Enter` で選択終了・コピー（自動でコピーモード終了）
6. `PREFIX ]` で貼り付け

#### マウス操作を有効にする

`.tmux.conf` に以下を追加すると、マウスでスクロールや選択ができるようになります：

```bash
set -g mouse on
```

ただし、マウスで選択した内容は OS のクリップボードではなく tmux のバッファにコピーされます。OS のクリップボードにコピーしたい場合は、`Shift` を押しながらマウスで選択すると、通常のターミナルと同じように選択・コピーできます。

#### 選択範囲を見やすくする

デフォルトでは選択範囲のハイライトが見づらい場合があります。`mode-style` で背景色と文字色を設定できます：

```bash
# 選択範囲を黄色背景・黒文字にする
set -g mode-style "bg=yellow,fg=black"
```

よく使われる色の組み合わせ：

| 設定                    | 見た目                           |
| ----------------------- | -------------------------------- |
| `"bg=yellow,fg=black"`  | 黄色背景・黒文字（視認性が高い） |
| `"bg=blue,fg=white"`    | 青背景・白文字                   |
| `"bg=magenta,fg=white"` | マゼンタ背景・白文字             |
| `"bg=cyan,fg=black"`    | シアン背景・黒文字               |

`reverse` を使うと前景色と背景色を反転できます：

```bash
set -g mode-style "reverse"
```

## .tmux.conf の設定例

`~/.tmux.conf` に設定を記述することで、tmux の挙動をカスタマイズできます。

### 設定ファイルの読み込みタイミング

`.bashrc` が新しいシェル起動のたびに読み込まれるのとは異なり、`.tmux.conf` は **tmux サーバーが起動する時に一度だけ**読み込まれます。

- tmux サーバーは最初の `tmux` コマンド実行時に起動し、すべてのセッションが終了するまで動き続ける
- 設定ファイルを編集しても、既存のサーバーには**自動で反映されない**
- 反映するには `source-file` コマンドで明示的に再読み込みが必要

### コマンドの省略形

`.tmux.conf` では、コマンドの省略形が使えます。どちらを使っても動作は同じです。

| 正式名              | 省略形   |
| ------------------- | -------- |
| `set-option`        | `set`    |
| `set-window-option` | `setw`   |
| `bind-key`          | `bind`   |
| `unbind-key`        | `unbind` |

### プレフィックスキーの変更

デフォルトの `Ctrl+b` を別のキーに変更する設定例：

```bash
# プレフィックスを Ctrl+a に変更
set -g prefix C-a
unbind C-b
bind C-a send-prefix
```

各行の意味：

| 設定                   | 説明                                                   |
| ---------------------- | ------------------------------------------------------ |
| `set -g prefix C-a`    | プレフィックスキーを `Ctrl+a` に設定                   |
| `unbind C-b`           | デフォルトの `Ctrl+b` を無効化                         |
| `bind C-a send-prefix` | `Ctrl+a` を2回押すと内側の tmux にプレフィックスを送信 |

#### send-prefix とは

`send-prefix` は **tmux をネスト（入れ子）して使う場合**に重要です。

例えば、SSH 先でも tmux を使っている場合：

```plain
┌─ ローカル PC ─────────────────────────────────┐
│ ┌─ ローカル tmux ───────────────────────────┐ │
│ │ ┌─ SSH 先 ────────────────────────────┐   │ │
│ │ │ ┌─ リモート tmux ─────────────────┐ │   │ │
│ │ │ │    ← ここを操作したい！         │ │   │ │
│ │ │ └─────────────────────────────────┘ │   │ │
│ │ └─────────────────────────────────────┘   │ │
│ └───────────────────────────────────────────┘ │
└───────────────────────────────────────────────┘
```

| 操作                      | 動作                                     |
| ------------------------- | ---------------------------------------- |
| `Ctrl+a` → `c`            | **ローカル**の tmux で新規ウィンドウ作成 |
| `Ctrl+a` → `Ctrl+a` → `c` | **リモート**の tmux で新規ウィンドウ作成 |

`send-prefix` を設定しないと、内側の tmux を操作する手段がなくなります。SSH 先でも tmux を使う可能性があるなら、設定しておくと安心です。

### 設定内容

```bash
# プレフィックスキーを Ctrl+a に変更（お好みで）
# set -g prefix C-a
# unbind C-b
# bind C-a send-prefix

# ウィンドウ・ペインの番号を 1 から開始（0 は押しにくいため）
set -g base-index 1
setw -g pane-base-index 1

# マウス操作を有効化
set -g mouse on

# 選択範囲のハイライトを見やすくする
set -g mode-style "bg=yellow,fg=black"

# vi 風キーバインドを使用
setw -g mode-keys vi

# 256色対応
set -g default-terminal "tmux-256color"

# ステータスバーを上部に表示
# set -g status-position top

# ペイン分割を直感的なキーに変更
bind | split-window -h  # 左右分割を | に
bind - split-window -v  # 上下分割を - に

# vim 風にペイン間を移動
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# 設定ファイルをリロード
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# ヒストリ上限を増やす
set -g history-limit 10000
```

### ステータスバーのカスタマイズ

ステータスバーの左側・右側に表示する内容をカスタマイズできます。

```plain
┌─ tmux セッション ──────────────────────────────────────────────────┐
│                                                                     │
│                         ターミナル画面                              │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│[0] PREFIX │ 0:bash  1:vim* │ "API Server" | CPU: 11.1% | Mem: 49%  │
│     ↑           ↑                              ↑                    │
│  status-left  ウィンドウ一覧              status-right              │
└─────────────────────────────────────────────────────────────────────┘
```

#### 基本的な設定

```bash
# ステータスバー左側（セッション名 + PREFIX インジケーター）
set -g status-left "[#S] #{?client_prefix,PREFIX ,}"
set -g status-left-length 40

# ステータスバー右側（ペインタイトル + CPU/メモリ使用率）
set -g status-right "\"#{pane_title}\" | CPU: #(top -bn1 | grep 'Cpu(s)' | awk '{print $2}')%% | Mem: #(free | grep Mem | awk '{printf \"%.0f%%%%\", $3/$2 * 100}') "
set -g status-right-length 60

# 更新間隔（秒）
set -g status-interval 1
```

#### よく使う変数

| 変数                | 表示内容                     |
| ------------------- | ---------------------------- |
| `#S`                | セッション名                 |
| `#W`                | ウィンドウ名                 |
| `#I`                | ウィンドウ番号               |
| `#P`                | ペイン番号                   |
| `#{pane_title}`     | ペインタイトル               |
| `#{=21:pane_title}` | ペインタイトル（最大21文字） |
| `#H`                | ホスト名                     |
| `#(コマンド)`       | コマンドの実行結果           |

#### 条件分岐

`#{?条件,真の場合,偽の場合}` で条件分岐ができます：

```bash
# PREFIX キーを押したときだけ「PREFIX」と表示
#{?client_prefix,PREFIX ,}

# PREFIX キーを押したときに背景色を変える
#{?client_prefix,#[bg=red]#[fg=white] PREFIX #[default],}
```

#### % 記号のエスケープ

tmux では `%` は特殊文字として扱われるため、リテラルの `%` を表示するにはエスケープが必要です：

| 設定ファイル | tmux 解釈後 | 最終表示                  |
| ------------ | ----------- | ------------------------- |
| `%%`         | `%`         | `%`                       |
| `%%%%`       | `%%`        | `%`（コマンド経由の場合） |

```bash
# CPU の後に % を表示（直接出力なので %%）
CPU: #(...)%%

# Mem の後に % を表示（awk 経由なので %%%%）
Mem: #(... awk '{printf \"%.0f%%%%\", ...}')
```

#### CPU/メモリ使用率の表示

システム全体のリソース使用率を表示する例：

```bash
# CPU使用率を取得
#(top -bn1 | grep 'Cpu(s)' | awk '{print $2}')

# メモリ使用率を取得
#(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}')
```

これらはシステム全体（コンテナ全体）の使用率であり、特定のペインやプロセスの使用率ではありません。

### 設定の反映方法

設定ファイルを変更した後は、以下のいずれかで反映します：

```bash
# 方法1: tmux 外から再読み込み
tmux source-file ~/.tmux.conf

# 方法2: tmux 内でコマンドモード（PREFIX :）から実行
:source-file ~/.tmux.conf

# 方法3: キーバインドで再読み込み（上記設定例の bind r を設定している場合）
PREFIX r
```

サーバーを完全に再起動したい場合：

```bash
# 全セッションを終了してサーバーを停止
tmux kill-server

# 再度 tmux を起動（新しい設定が読み込まれる）
tmux
```

### 設定のリセット

一度設定したオプションをデフォルトに戻すには、`-u` (unset) オプションを使います。

```bash
# グローバルオプションをリセット
set -gu オプション名

# ウィンドウオプションをリセット
setw -gu オプション名
```

例：

```bash
# mode-style をデフォルトに戻す
set -gu mode-style

# mode-keys をデフォルト（emacs）に戻す
setw -gu mode-keys

# プレフィックスキーをデフォルト（Ctrl+b）に戻す
set -gu prefix
```

フラグの意味：

| フラグ | 意味                                     |
| ------ | ---------------------------------------- |
| `-u`   | unset（設定解除してデフォルトに戻す）    |
| `-g`   | global（グローバル設定に対して操作）     |
| `-gu`  | グローバル設定を解除してデフォルトに戻す |

`-g` をつけないと、現在のセッション/ウィンドウのみに適用されます。

### 現在の設定値を確認する

```bash
# グローバルオプションの一覧
tmux show-options -g

# 特定のオプションの値を確認
tmux show-options -g mode-style

# ウィンドウオプションの一覧
tmux show-window-options -g
```

## よく使うワークフロー

### 1. 作業の開始

```bash
# 名前付きセッションを作成して開始
tmux new -s work
```

### 2. 作業の中断と再開

```bash
# 作業中に別の用事ができたらデタッチ
PREFIX d

# 後で再開
tmux a -t work
```

### 3. 複数のペインでログを監視しながら作業

```bash
# tmux を起動後
PREFIX "           # 上下に分割
PREFIX 矢印キー(上) # 上のペインに移動
tail -f /var/log/app.log  # ログを表示
PREFIX 矢印キー(下) # 下のペインに戻って作業
```

## 参考資料

- [とほほの tmux 入門](https://www.tohoho-web.com/ex/tmux.html)
- [tmux を始める基本設定](https://zenn.dev/murachi/articles/36d7676558d5535b44db)
- [tmux 設定の紹介](https://qiita.com/youichiro/items/dd54c38c2f3873348c78)
- [tmux に習熟するために覚えたい概念](https://qiita.com/dogyear/items/f3e460988bebf316e32c)
- [いまさら tmux 入門](https://qiita.com/shoma2da/items/2e68c1e59938eb0c2f83)
- [tmux の使いづらい設定を変える](https://zenn.dev/ken5l/articles/9ef9df319f66a2)
- [tmux 初心者向けガイド](https://www.redhat.com/ja/blog/introduction-tmux-linux)
