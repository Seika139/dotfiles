# rsync

高速な差分ファイル転送を行う
cp が愚直にコピーするのに対して、 rsync は高速に差分だけを転送する。
ネットワーク越しに異なるマシンにも転送できる。

```bash
rsync [オプション] [転送元] [転送先]

# 例: リモートからローカルにファイルを転送する
rsync -ahvn username@hostname:/var/www/html/* /var/www/html/
```

## 差分の判断基準

デフォルトでは

- ファイルサイズが異なる
- 最終更新日時（mtime）が異なる

場合に転送対象となる。

### 転送対象になるケース（具体例）

以下のような状態のとき、rsync はそのファイルを転送対象リストに入れます。

- 新規ファイル: 送り先にまだ存在しないファイル。
- 内容の更新: 上記のサイズや更新日時が変わっているファイル。
- 属性の変更: オプション（`-p` や `-g` など）によるが、権限（パーミッション）や所有者が変わった場合も同期の対象になる。
- リンクの不一致: シンボリックリンクのリンク先が変わった場合など。

### 差分の判断基準を変えるオプション

|     オプション      | 意味                                                                                       |
| :-----------------: | :----------------------------------------------------------------------------------------- |
| `-c` / `--checksum` | サイズや時間ではなくハッシュ値（チェックサム）で内容を比較する。確実だが計算に時間がかかる |
|  `-u` / `--update`  | 送り先のファイルの方が新しい（更新日時が新しい）場合は転送をスキップする                   |
| `--ignore-existing` | 送り先にすでにファイルが存在する場合、中身に関わらず一切更新しない（新規ファイルのみ送る） |
|    `--size-only`    | ファイルサイズの比較のみを行う                                                             |

※ `--checksum` による比較の場合は、ファイルのタイムスタンプによる比較は行われない。

**`--size-only` と `--no-t` の違い**

`--size-only` は比較時のオプションで、`--no-t` は転送時のオプション。
`--no-t` はファイルサイズが同じでタイムスタンプが違う場合でも転送対象になる。ただしタイムスタンプは結局変わらない。

## 末尾の / に注意

転送元の指定には要注意。

```bash
$ ls src
a.txt b.txt
```

上記の例の場合

```bash
$ rsync -a src dest # dest 内に src ディレクトリがコピーされる
$ ls dest
src
```

上記のように末尾の `/` をつけないと `src` ディレクトリが `dest` 内に作られる。

```bash
$ rsync -a src/ dest # dest 内に src ディレクトリの中身を転送する
$ ls dest
a.txt b.txt
```

一方で `src/` とすると `dest` 内には `src` ディレクトリの中身が同期される。

## その他の注意点

- 転送元と転送先が逆になっていないか
- 特に `--delete` オプションをつけている場合は復帰できない
- 実行前に `-nv` オプションで dry-run をすること

## オプション

### 出力内容に関するオプション

|        オプション         | 意味                                                   |
| :-----------------------: | :----------------------------------------------------- |
|    `-v` / `--verbose`     | コピーしたファイル名やバイト数などの転送情報を出力する |
|      `-q`/ `--quiet`      | 動作中のメッセージを抑制する                           |
| `-h` / `--human-readable` | ファイルサイズの bytes を K や M で出力する            |
|       `--progress`        | 転送の進行状況を表示する                               |

### その他のオプション

|         オプション         | 意味                                                   |
| :------------------------: | :----------------------------------------------------- |
|     `-a` / `--archive`     | アーカイブモード（ `-rlptgoD -no-H -no-A -no-X` 相当） |
|    `-r` / `--recursive`    | 指定ディレクトリ配下をすべて対象とする                 |
|     `-n` / `--dry-run`     | コピーや転送を実際には行わず転送内容のみ出力する       |
|     `-b` / `--backup`      | バックアップを作成する (デフォルトで ~ が付く)         |
|    `-z` / `--compress`     | 圧縮・展開のCPUコストがかかるが通信量が減る            |
|         `--delete`         | 転送元に存在しないものが転送先にあったら削除する       |
|        `--partial`         | 転送を中断したファイルを保持する                       |
|          `--no-t`          | タイムスタンプを同期しない                             |
| `-i` / `--itemize-changes` | なぜそのファイルが選ばれたのかを表示する               |

#### itemize-changes の読み方

ファイル名の左側に `>f.st....` のような記号が出る。

```bash
$ rsync -anhvi codex/profiles/win-15034/ codex/profiles/wsl-ubuntu/
Transfer starting: 9 files
.d..t.... ./
>f.st.... AGENTS.md
>f.st.... config.toml
>f+++++++ notify.ps1
.d..t.... prompts/
>f..t.... prompts/execute-release.md
>f..t.... prompts/prepare-release.md
>f..t.... prompts/review-design-doc.md
>f..t.... prompts/review-pr.md

sent 474 bytes  received 74 bytes  261k bytes/sec
total size is 21970  speedup is 40.09
```

|  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| `>` | `f` | `.` | `s` | `t` | `.` | `.` | `.` | `.` |

**2番目**

- f:普通のファイル
- d:ディレクトリ
- L:シンボリックリンク
- D:デバイスファイル
- S:ソケット

**4番目**

- `s`: サイズ（Size）が異なる
- `.`: 変更なし

**5番目**

- `t`: 更新日時（Time）が異なる
- `T`: 更新日時（Time）が異なるが、転送してもタイムスタンプが置き換えられない
- `.`: 変更なし

`>f+++++++` の場合は、新規作成されるファイルを表す。

## とにかく2つのディレクトリに差分があるかを知りたいとき

`--out-format="%n"` とすることで、転送対象のファイル名のみを表示する（`-v`はつけないこと）

```bash
# チェックサムによる比較
rsync -rnc --out-format="%n" src/ dest/

# ファイルサイズとタイムスタンプによる比較
rsync -rn --out-format="%n" src/ dest/

# ファイルサイズのみで比較
rsync -rn --size-only --out-format="%n" src/ dest/
```
