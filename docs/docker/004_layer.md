# Layer

Docker のイメージ、コンテナはレイヤーの集まりであるとみなすことができる。
ここでのレイヤーとは「変更差分」のことであり、Dockerfile に記述された 1 つ 1 つの命令がレイヤーを作成する。
`docker build` コマンドを実行すると、Dockerfile の各命令に基づいてレイヤーが作成され、最終的なイメージが生成される。
このとき、各レイヤーは前のレイヤーに基づいて変更を加えたものとなる。
レイヤーはイメージの変更履歴を保持しており、同じレイヤーを持つイメージはキャッシュとして再利用されるため、ビルド時間を短縮できる。

同じイメージから複数のコンテナを起動することができるが、各コンテナは同じレイヤーを共有しているため、ストレージの効率的な利用が可能である。逆にコンテナ A に変更を加えてもコンテナ B には影響を与えないのは、コンテナレイヤーは共有されていないからである。

## レイヤー数を少なくする理由

最終的なイメージの容量を小さくするためには、レイヤーの数を減らすことが重要である。
そもそもイメージを小さくすることには下記のようなメリットがある。

1. パフォーマンスの向上 - 小さいイメージはダウンロード、アップロード、デプロイが速くなる
1. ストレージ容量の節約 - レジストリやホストマシンでの保存スペースが少なくて済む
1. セキュリティの向上 - 不要なツールやライブラリが含まれないため、攻撃対象領域が減少する
1. 管理のしやすさ - シンプルなイメージは管理が容易

## イメージを小さくする方法

### Alpine Linux ベースのイメージを使用する

Alpine Linux は非常に小さいディストリビューション（約 5MB）で、多くの公式 Docker イメージで利用可能。

### slim バリアントを利用する

Debian や Ubuntu の公式イメージには、`-slim` バリアントが用意されている。
これらは、不要なパッケージやツールを削除した軽量版であり、通常のイメージよりも小さくなっている。
例えば、`python:3.9-slim` は `python:3.9` よりも小さい。

### マルチステージビルドを使用する

イメージビルド時に複数のステージを利用することで、ビルドに必要なツールや中間生成物を含まないアプリケーションの実行に必要な最小限のイメージを作成できる。

#### マルチステージビルドを利用する場合、しない場合

Node.js アプリケーションをビルドする場合を例に説明する。

- シングルステージビルド
  - node イメージをベースに、npm で依存関係をインストールし、アプリケーションをビルドする。最終的なイメージには、npm や Node.js の開発に必要なツールなどが含まれる。
- マルチステージングビルド
  - ビルドステージ: node イメージをベースに、依存関係をインストールし、アプリケーションをビルドする。
  - 実行ステージ: より軽量な node:alpine イメージなどをベースに、ビルドステージで生成された dist フォルダや必要なファイルだけをコピーする。最終的なイメージには、npm や開発ツールは含まれない。

#### マルチステージビルドの例

- 複数の `FROM` 命令を使用して、ビルドと実行の 2 つのステージを定義する。
- 最初のステージでは、アプリケーションをビルドするためのツールや依存関係を含むイメージを使用する。
- 2 つ目のステージでは、ビルドされたアプリケーションのみを含む軽量なイメージを使用する。

```dockerfile
# ビルドステージ
FROM golang:1.20 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN go build -o app

# 実行ステージ
FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/app .
EXPOSE 8080
CMD ["./app"]
```

## 参考

- [レイヤ — Docker-docs-ja 24.0 ドキュメント](https://docs.docker.jp/build/guide/layers.html)
- [Dockerfile を理解して書きたくてレイヤ構造を拝んできた忘備録 #dockerfile - Qiita](https://qiita.com/marumeru/items/5b9d19508fa649d060a7)
- [Docker コンテナのレイヤ構造とは？ #入門 - Qiita](https://qiita.com/okmtz/items/f8231c83134a6363647b)
