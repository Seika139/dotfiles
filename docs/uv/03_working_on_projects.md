# Project 内で uv を活用する

## プロジェクトの作成

- 新しいプロジェクトを uv で初期化するには、以下のコマンドを使用します：

```bash
# my-project という名前の新しいプロジェクトを作成（ディレクトリも作成されます）
uv init my-project
cd my-project

# 既存のプロジェクトで uv を使用開始する場合（カレントディレクトリに uv 管理ファイルを作成します）
uv init
```

このコマンドを実行すると以下のファイルが生成されます（存在する場合は上書きされません）

```plain
my-project/
├── .gitignore
├── .python-version
├── README.md
├── main.py
└── pyproject.toml
```

さらに、`uv run`, `uv sync`, `uv lock` などのプロジェクトに関するコマンドを初回実行すると

- `.venv/`（仮想環境ディレクトリ）
- `uv.lock`（依存関係ロックファイル）

が生成されます。

## pyproject.toml

プロジェクトのメタデータと依存関係を管理するためのファイルです。uv init 実行直後では以下のような情報が含まれます。

```toml
[project]
name = "my-project"
version = "0.1.0"
description = "A sample project using uv"
readme = "README.md"
dependencies = []
```

readme フィールドはプロジェクトの説明を含むファイルを指定します。`README.md` が一般的です。
ここで指定したファイルが存在しないとビルド時にエラーになるので注意してください。

## .python-version

プロジェクトのデフォルトの Python バージョンを指定するためのファイルです。
プロジェクトの仮想環境を作成する際に uv はこのファイルを参照して仮想環境を作成します。

```plain
3.12
```

### requires-python の設定

`pyproject.toml` の `[project]` セクション内に `requires-python` フィールドを追加して Python バージョン要件を指定することもできますが、`.python-version` とは立ち位置が異なるため両方設定しておくことを推奨します。

```toml
[project]
requires-python = ">=3.12"
```

requires-python は **「このプロジェクトが動作可能な Python のバージョン範囲」**を、パッケージのメタデータとして宣言するもので、 pip や uv が依存関係の解決時に参照します。

例えば以下のような場合…

```toml
[project]
requires-python = ">=3.10,<3.13"
```

```plain
3.12.6
```

開発環境には 3.12.6 が使用されますが、パッケージは 3.10 から 3.12 までのバージョンで動作可能であることを示しています。

## lock と sync

<https://docs.astral.sh/uv/concepts/projects/sync/>

uv はプロジェクトの仮想環境を自動的に同期する機能を備えています。

- lock とは: プロジェクトの依存関係をロックファイルに保存することを指します。デフォルトでは `uv.lock` に保存されます。
- sync とは: ロックファイルに基づいてプロジェクトの仮想環境を更新することを指します。

## 自動同期

uv は `uv run` や `uv sync` などのコマンド実行時に自動的に lock と sync を行います。
ただし、 `pyproject.toml` を更新したり、依存関係の解決に失敗して lock ファイルと仮想環境に不整合が生じた場合は sync やその他の uv コマンドがエラーになります。
このような場合は `uv lock` を実行してロックファイルを更新し、その後 `uv sync` を実行して仮想環境を更新してください。

### lock が古くてコマンドがエラーになる場合

```bash
uv lock # ロックファイルを更新
uv sync # ロックファイルに基づいて仮想環境を更新
```

### CI 環境などで再現性を重視する場合

```bash
uv sync --frozen # ロックファイルが最新でない場合にロックを更新せずにそのまま利用する
```

### パッケージのアップデートをして最新の依存関係にしたい場合

```bash
uv lock --upgrade # すべての依存関係を最新バージョンに更新
uv sync           # ロックファイルに基づいて仮想環境を更新

# まとめて一行で実行する場合
uv sync --upgrade # 仮想環境の依存関係を最新バージョンに更新
```

## 仮想環境を再作成したい場合

仮想環境が壊れてしまった場合や、Docker イメージのビルドなどでクリーンな環境を作成したい場合は以下のコマンドを使用します。

```bash
uv venv --clear               # 既存の仮想環境を削除して作り直す
uv venv --clear --python 3.11 # 指定した Python バージョンで仮想環境を作り直す

uv sync            # ロックファイルに基づいて新しい仮想環境を作成
uv sync --upgrade  # 依存関係を最新バージョンに更新しつつ新しい仮想環境を作成
```

## uv.lock

プロジェクトの依存関係に関する正確な情報を含むクロスプラットフォームのロックファイルです。
uv sync や uv lock コマンドを実行すると自動的に生成・更新されます。手動で編集してはいけません。

### uv lock

- `uv lock` : `uv.lock` を明示的に生成・更新します。
- `uv lock --check` : 依存関係がロックファイルと一致しているか確認します。
- `uv lock --upgrade` : lock ファイルの依存関係を最新バージョンに更新します。
- `uv lock --upgrade-package <package>` : 指定したパッケージのみを最新バージョンに更新します。

#### Dockerfile などで世話になるオプション

- `--frozen` : 通常はロックファイルが最新でない場合に uv はエラーを発生させますが、このオプションを指定するとロックファイルが最新でない場合でもエラーを発生させずに処理を続行します。

### uv sync

- `uv sync` : ロックファイルに基づいてプロジェクト環境を明示的に更新します。
- `uv sync --dry-run` : 実際には変更を加えずに、同期によって行われる変更を表示します。
- `uv sync --inexact` : ロックファイルに存在しないパッケージを削除したくない場合に使用します。

※ `uv sync` で同期する依存関係の種類については [pyproject.toml で依存関係を管理する](04_managing_dependencies.md) を参照してください。

#### Dockerfile などで世話になるオプション

- `--frozen` : 通常はロックファイルが最新でない場合に uv はエラーを発生させますが、このオプションを指定するとロックファイルが最新でない場合でもエラーを発生させずに処理を続行します。
- `--no-install-project` : 現在のプロジェクトをインストールしないようにします。
