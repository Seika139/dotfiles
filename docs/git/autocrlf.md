# 行終末文字・改行コードについて

| 名称                                   | 意味                                                    | コード | 向き  | OS          |
| :------------------------------------- | :------------------------------------------------------ | :----- | :---- | :---------- |
| CR（Carriage Return）                  | カーソルを左端の位置に移動する。復帰。                  | \r     | ←     | macOS9 以前 |
| LF（Line Feed）                        | カーソルを次の行に移動する。改行。                      | \n     | ↓     | macOSX 以降 |
| CR + LF（Carriage Return + Line Feed） | カーソルを左端に移動して、次の行に移動する。復帰+改行。 | \r\n   | ← + ↓ | Windows     |

## git の設定 autocrlf とは

上記の表のように windows とそれ以外とで改行コードが異なる。
そこで、git では autocrlf という設定項目に応じて、チェックアウト・コミット時に改行コードを調整する。

現在の設定は `git config core.autocrlf` で確認できる。

| 設定  | チェックアウト時 | コミット時 |
| :---- | :--------------- | :--------- |
| true  | LF -> CRLF       | CRLF -> LF |
| input | 変換しない       | CRLF -> LF |
| false | 変換しない       | 変換しない |

true か input を推奨。
これらの場合は、コミット時に LF に変換されるので、リモートが常に LF で保たれる。
true の場合は、windows ユーザーがチェックアウトすると CRLF に変換される。

- 参考: [気をつけて！Git for Windows における改行コード #Git - Qiita](https://qiita.com/uggds/items/00a1974ec4f115616580)

git config の項目は GitHub などで共有されず、個々の PC の設定に依存する。
リモートリポジトリには行終末文字の設定は存在せず、単にファイルの内容が保存されるだけ。
したがって、PC ごとに適切に git config の設定をする必要がある。
他の開発者や環境で一貫した行終末文字の扱いを保証するためには、`.gitattributes`ファイルを使用することを検討する。詳しくは後述。

## file コマンド

```bash
$ file [ファイル名]

# あるディレクトリ下にあるすべてのファイルに対して file コマンドを実行する。
# -name "*sh" や -maxdepth N などのオプションを利用して出力を絞り込む
$ find [ディレクトリ] -type f -exec file {} \;
```

file コマンドでは「ファイル形式」を拡張子などに頼らず、ファイルの中身から判断してその形式を出力する。
その出力に `with CRLF line terminators` が含まれる場合は、ファイルが CRLF 形式になっている。

```bash
# 例 dotfiles 下の sh または bash 形式のファイルについて、その中身の形式を出力する
$ find . \( -name "*.sh" -o -name "*.bash" \) -type f -exec file {} \;
```

シンボリックリンクについては下記のように動作する。

```bash
$ file [シンボリックリンク]
symbolic link to リンク元のファイルパス
$ file -L [シンボリックリンク]
リンク元のファイル情報が出力される。
```

## shell script の改行コードについて

.sh や .bash などは Unix 系のシステムで実行されることが多いので、VS Code の拡張機能「ShellCheck」では CRLF の改行コードがあると警告を出す。
実際、UNIX 系のシステムで CRLF が混ざった状態で shell script を実行すると失敗することが多い。
そこで、windows でもシェルスクリプトについては LF でファイルが開かれるようにしたい。

### Windows において Git の設定で特定のファイルだけを LF で取り扱うようにする

1. **プロジェクトのルートディレクトリに`.gitattributes`ファイルを作成または編集する**：
   プロジェクトのルートディレクトリに`.gitattributes`ファイルがない場合は、新しく作成します。既に存在する場合は、編集します。

2. **シェルスクリプトファイルのエントリを追加する**：
   `.gitattributes`ファイルに以下のエントリを追加します。これにより、シェルスクリプトファイル（拡張子が`.sh`のファイル）は常に LF で扱われるようになります。

   ```txt
   *.sh text eol=lf
   ```

   この設定により、Git はシェルスクリプトファイルをコミットする際に自動的に行終末文字を LF に変換します。

3. **既存のリポジトリに対して設定を適用する**：
   既にリポジトリに存在するシェルスクリプトファイルに対して設定を適用するためには、一度ファイルを再チェックアウトする必要があります。以下のコマンドを実行してください。

   ```sh
   git add --renormalize .
   git commit -m "Normalize line endings for shell scripts"
   ```

これで、シェルスクリプトファイルは常に LF で扱われるようになります。その他のファイルは、`core.autocrlf`の設定に従って CRLF で扱われます。

## .gitattributes について

`.gitattributes`ファイルの設定は、Git がファイルを処理するさまざまなタイミングで利用されます。具体的には、以下のような操作時に利用されます。

### 1. **ファイルのチェックアウト時**

リポジトリからファイルをワーキングディレクトリにチェックアウトする際に、`.gitattributes`の設定が適用されます。例えば、行終末文字の変換設定（`eol`）がある場合、指定された形式に変換されます。

### 2. **ファイルのコミット時**

ファイルをステージングエリアに追加（`git add`）する際やコミットする際にも、`.gitattributes`の設定が適用されます。これにより、ファイルの内容がリポジトリに保存される前に、指定された形式に変換されます。

### 3. **ファイルのマージ時**

ブランチのマージやリベース操作を行う際にも、`.gitattributes`の設定が適用されます。これにより、マージコンフリクトが発生した場合でも、指定された形式に従って解決されます。

### 4. **ファイルの比較時**

`git diff`コマンドなどでファイルの差分を比較する際にも、`.gitattributes`の設定が適用されます。これにより、行終末文字の違いなどが無視され、実際の内容の違いのみが表示されます。

### 具体的な例

例えば、`.gitattributes`ファイルに以下の設定があるとします：

```plaintext
*.sh text eol=lf
*.bat text eol=crlf
```

- **シェルスクリプト（`.sh`ファイル）**は、常に LF 行終末文字で扱われます。
- **バッチファイル（`.bat`ファイル）**は、常に CRLF 行終末文字で扱われます。

### 実際の利用タイミング

1. **チェックアウト時**：

   - リポジトリからファイルをチェックアウトする際に、`.sh`ファイルは LF 行終末文字に変換され、`.bat`ファイルは CRLF 行終末文字に変換されます。

2. **コミット時**：

   - ファイルをステージングエリアに追加する際に、`.sh`ファイルは LF 行終末文字に変換され、`.bat`ファイルは CRLF 行終末文字に変換されます。

3. **マージ時**：

   - ブランチをマージする際に、`.gitattributes`の設定に従って行終末文字が適切に処理されます。

4. **比較時**：
   - `git diff`を実行する際に、`.gitattributes`の設定に従って行終末文字の違いが無視され、実際の内容の違いのみが表示されます。

## VS Code の設定

`settings.json`ファイルに以下の設定を追加します。これにより、シェルスクリプト（拡張子が`.sh`のファイル）に対してのみ行終末文字が LF に設定されます。

```json
{
  "[shellscript]": {
    "files.eol": "\n"
  }
}
```

既に他の設定が存在する場合は、適切な位置にこの設定を追加してください。

### 設定の効果

- **シェルスクリプトファイル**：拡張子が`.sh`のファイルを開いたときに、デフォルトで LF が行終末文字として使用されます。
- **他のファイル**：他のファイルタイプには影響を与えず、通常の設定が適用されます。

### 注意点

- この設定は、VS Code 全体に適用されるため、他のプロジェクトやワークスペースでも同様に動作します。特定のプロジェクトに対してのみ適用したい場合は、ワークスペース設定を使用します。

### ワークスペース設定

特定のプロジェクトに対してのみこの設定を適用したい場合は、ワークスペース設定を使用します。ワークスペース設定はプロジェクトのルートディレクトリに`.vscode`フォルダを作成し、その中に`settings.json`ファイルを配置します。

```json
{
  "[shellscript]": {
    "files.eol": "\n"
  }
}
```

これにより、そのプロジェクト内でのみシェルスクリプトファイルが LF で扱われるようになります。
