# ブランチと HEAD の概念を理解する

## 結論

- HEAD : 今自分が作業している場所を示すポインタ
- Branch : 開発の流れを分岐させる機能。Branch も特定の場所を示すポインタにすぎない。基本的に流れの先端にある。
- detached HEAD : HEAD が Branch をさしていない状態のこと。

## コミットしたときに何が起きるか

`git commit` したとき「コミットオブジェクト」が作成される。
コミットオブジェクトは以下の要素を持つ

- ツリーオブジェクト(ステージングされたファイルのスナップショット)へのポインタ
- 親コミットへのポインタ。マージされた時は複数ある。
- 作者情報などのメタデータ

その後、ブランチのポインタを最新のコミットオブジェクトに進める。
結局のところブランチはコミットを指すポインタにすぎない。

## HEAD とは

HEAD も中身はポインタで今自分がいる場所を指すという意味で唯一の存在である。
HEAD がブランチを指す場合は、「HEAD がブランチのポインタをもつ」「ブランチはコミットのポインタを持つ」という関係になっている。
このときにコミットが発生すると、ブランチの指すコミットが動くので、HEAD が指す先も変わることになる。

`git checkout [コミットID]` でブランチではないコミット ID に現在地、つまり HEAD を意図的に移すことができる。
これが detached HEAD の状態だ。通常だとリベースの時などに起こる。

また `git reflog` は HEAD の移動遍歴(つまり自分の操作履歴)を見ることができる。
これは `git reset --hard` をした時もその履歴が残っているのでコミット内容を復元することができる。(コミットしてない変更の情報は復元されないので悪しからず)

また、`git stash` などの行為をしたあとに `git reflog` を実行すると、
同じコミット ID に対して HEAD@{N}が割り当てられるので、`git checkout HEAD~N` で過去に戻る時の N とズレる。 <!-- TODO 疑問点 -->
したがって、`git checkout HEAD~N` で過去に戻る時は `git log` などでコミット数をカウントしたほうが良さそう。

HEAD はコマンドで扱う時は `@` がエイリアスになっている。( `git checkout HEAD~2` は `git checkout HEAD~2` と同義)

## ^と~について

`HEAD~N` は HEAD の N 個前の(1 番目の親の)コミットを指す。(N=1 の時は `HEAD~` で良い)

`HEAD^N` は HEAD の N 番目の親のコミットを指す。(マージで複数の親が存在するときに使う)
ただし、 `HEAD^^` は HEAD の 1 番目の親の 1 番目の親となるので、結果的に `HEAD~2` と同じになる。

- `HEAD~3^2` : これは、3 世代前のコミットの 2 番目の親を表します（つまり 3 世代前のコミットでマージされている）。

```plain
o---o---o---o---o---HEAD
      /
o---x-  <== コレ
```

- `HEAD^2~3` : これは、2 番目の親の 3 世代前のコミットを表します（つまり最新のコミットでマージされている）。

```plain
        o---o---o---o---HEAD
                       /
コレ ==> o---o---o---o-
```

## 参考

- [Git の HEAD とは何者なのか](https://qiita.com/ymzk-jp/items/00ff664da60c37458aaa)
- [【連載】マンガでわかる Git ～コマンド編～ / 第 7 話 間違えて reset しちゃった？git reflog で元どおり](https://www.r-staffing.co.jp/engineer/entry/20191227_1)
- [[git reset (--hard/--soft)]ワーキングツリー、インデックス、HEAD を使いこなす方法 / (注) reflog は万能ではない](https://qiita.com/shuntaro_tamura/items/db1aef9cf9d78db50ffe#%E6%B3%A8-reflog%E3%81%AF%E4%B8%87%E8%83%BD%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84)
- [Git で N 個前のコミットを表現する](https://maku77.github.io/git/other/represent-commit.html)
- [Git 公式 / 3.1 Git のブランチ機能 - ブランチとは](https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%A9%9F%E8%83%BD-%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%A8%E3%81%AF)
