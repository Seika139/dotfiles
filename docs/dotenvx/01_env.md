# 環境変数の取り扱い

## 12 Factors Ⅲ. Config

- <https://12factor.net/ja/config>

ウェブアプリケーションや SaaS の開発におけるベストプラクティスとして知られる [The Twelve-Factor App](https://12factor.net/) の第三の要素である「Config（設定）」では、アプリケーションの設定情報をコードベースから分離し、環境変数を使用して管理することが推奨されています。

アプリケーションの設定情報（データベースの接続情報、API キー、シークレットなど）をソースコードに直接埋め込むのではなく、環境変数として外部から注入することで、以下のような利点があります：

- **セキュリティの向上**: 機密情報をコードベースから分離することで、誤って公開リポジトリにコミットしてしまうリスクを軽減します。
- **柔軟なデプロイメント**: 同じコードベースを異なる環境（開発、ステージング、本番など）で使用する際に、環境変数を変更するだけで設定を切り替えられます。
- **一貫性の確保**: 環境変数を使用することで、異なる環境間での設定の一貫性を保ちやすくなります。

それを実現するためのツールとして、`.env` ファイルを読み込み、環境変数として設定するライブラリが多く存在します。これにより、開発者はローカル環境で簡単に設定を管理でき、本番環境では安全に環境変数を注入できます。

しかし、`.env` ファイルには機密情報が含まれることが多いため、gitなどのバージョン管理システムにコミットしないように注意する必要があります。
通常、`.env` ファイルは `.gitignore` に追加して管理します。

## 環境変数と環境変数ファイル

ここでは、環境変数と環境変数ファイルの基本的な概念について説明します。

### 環境変数とは

環境変数は、オペレーティングシステムや実行環境に設定されるキーと値のペアであり、アプリケーションが動作する際の設定情報を提供します。これにより、アプリケーションは外部から設定情報を受け取り、柔軟に動作を変更できます。

```bash
echo $DATABASE_URL
```

のようにして CLI から `echo 環境変数名` で確認できます。

また以下のコマンドですべての環境変数を一覧表示できます。

```bash
printenv # Unix/Linux/Mac
set      # Windows
Get-ChildItem Env: # PowerShell
```

### 環境変数ファイルとは

環境変数ファイルは、環境変数のキーと値のペアをテキスト形式で保存したファイルです。

冪等な実行環境を担保するうえで、このような環境変数ファイルを利用することは非常に有用です。
もし、環境変数ファイルが存在しない場合、利用者が手動で OS に環境変数を設定する必要があり、設定漏れや誤設定のリスクが高まります。
それに対して、環境変数ファイルはプログラム起動時に読み込まれ、中身が環境変数としてメモリに展開されることで、同一の設定を簡単に再現できます。

モダンなアプリケーション開発においては、`.env` という名前のファイルがよく使用されます。
このファイルには、以下のように `KEY=VALUE` の形式で環境変数が定義されます。

```plain
DATABASE_URL=postgres://user:password@localhost:5432/my-db
API_KEY=your_api_key_here
```

他にも OS そのものやターミナルシェルの設定ファイル（例: `.bashrc`, `.zshrc`, `.profile` など）に環境変数を定義することもあります。

Docker を利用した開発環境では、`docker-compose.yml` 内で `environment` セクションを使用して環境変数を定義したり、 `env_file` セクションで外部の環境変数ファイルを指定したりすることも一般的です。

## 言語・フレームワーク別、環境変数ファイルの取り扱い

### uv (Astral uv)

- <https://docs.astral.sh/uv/concepts/configuration-files/>

uv では環境変数 `UV_ENV_FILE` に .env ファイルのパスを指定することで、そのファイルから環境変数を読み込みます。

つまり以下のように実行します：

```bash
UV_ENV_FILE=.env uv run app.py
```

また uv run コマンドは `--env-file` オプションもサポートしており、こちらでも同様に .env ファイルを指定できます。

```bash
uv run --env-file .env app.py
```

### Next.js

- <https://nextjs-ja-translation-docs.vercel.app/docs/basic-features/environment-variables>

Next.js ではサーバーを起動する際の環境に応じて、以下のように複数の環境変数ファイルをサポートしています：

#### 開発環境

`npm run dev` または `next dev` コマンドで開発サーバーを起動する際には、環境変数 `NODE_ENV` が `development` に設定されます。この場合、Next.js は以下の優先順位で環境変数ファイルを読み込みます。

1. `.env.development.local`
2. `.env.local`
3. `.env.development`
4. `.env`

#### 本番環境

`npm run start` または `next start` コマンドで本番サーバーを起動する際には、環境変数 `NODE_ENV` が `production` に設定されます。この場合、Next.js は以下の優先順位で環境変数ファイルを読み込みます。

1. `.env.production.local`
2. `.env.local`
3. `.env.production`
4. `.env`

#### テスト環境

jest や vitest などのテストランナーを使用してテストを実行する際には、環境変数 `NODE_ENV` が `test` に設定されます。この場合、Next.js は以下の優先順位で環境変数ファイルを読み込みます。

1. `.env.test.local`
2. `.env.test`
3. `.env`

※ .env.local は読み込まれません。

#### まとめ

上記より .env を共通の環境設定ファイルとして利用し、環境ごとの設定は個別のファイルで上書きする形が推奨されます。
また、`.local` サフィックスが付いたファイルは、さらに個人用に上書きするための用途で使われます。
秘匿性の高い環境変数を `.enc.*.local` にのみ定義して git ignore の対象にするのであれば `.env` を git 管理下に置いても問題ありません。

#### その他の注意点

- ブラウザでも環境変数を参照する場合は環境変数名に`NEXT_PUBLIC_` プレフィックスを付与する必要があります。秘匿性の高い環境変数がクライアントサイドに漏洩しないよう注意してください。
- `npm run dev` や `next dev` を実行中に環境変数を変更しても、変更は反映されません。Next.js サーバーの再起動が必要です。

## 環境設定ファイルとバージョン管理

ここまでに説明したように、環境設定ファイル（例: `.env`）には機密情報が含まれることが多いため、バージョン管理システム（例: Git）にコミットしないように注意する必要があります。
通常、環境設定ファイルは `.gitignore` に追加して管理します。

```plain
# .gitignore の例
.env
.env.local
.env.*.local
```

このように秘匿性の高い環境設定ファイルをバージョン管理から除外することで、誤って公開リポジトリにコミットしてしまうリスクを軽減できます。
チームで開発を行う場合は、環境設定ファイルのサンプル（例: `.env.example`）を用意し、必要な環境変数のキーと説明を記載しておくことが推奨されます。

しかしチーム開発においてこの運用方法は意外と面倒です。各環境変数の設定値を Git とは別に安全に共有・同期する仕組みが必要になるからです。
そのため、最近では環境変数管理に特化した外部サービス（例: Doppler、Vault、AWS Secrets Manager など）を利用するケースも増えています。

ここではもっともシンプルに環境変数ファイル自体を暗号化してバージョン管理する `dotenvx` を利用する方法を紹介します。

[02_dotenvx.md](./02_dotenvx.md) に続く。
