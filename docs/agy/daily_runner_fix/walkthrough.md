# 日次スクリプトの重複実行防止 完了報告

## 変更内容

日次処理が実行中に別のシェルを立ち上げた際、二重に処理が走らないようにする排他制御（ロック機構）を導入しました。

### [Component Name] bash

#### [MODIFY] [22_daily_runner.bash](file:///Users/suzukikenichi/dotfiles/bash/public/22_daily_runner.bash)

- **ロックファイルの導入**: `bash/daily/.cache/runner.lock` に実行中のプロセスID (PID) を記録するようにしました。
- **実行中チェック**: すでにロックファイルが存在し、そのPIDが実行中の場合は、処理をスキップするようにしました。
- **Stale Lock対策**: 前回のシェルがクラッシュ等で正常に終了しなかった場合（ロックファイルだけが残っている場合）でも、PIDを確認してプロセスがいなければ自動でリカバリして実行を続行します。
- **後処理**: スクリプトが正常終了した際や、途中で中断 (Ctrl+C など) された際にも、確実にロックファイルを削除するように `trap` を設定しました。

## 検証結果

### 手動確認内容

1. 時間のかかるスクリプトを実行中に、別のタブなどで新しいシェルを起動。
2. 「デイリー処理が既に他のシェル(PID: ...)で実行中のため、スキップします」というメッセージが表示され、重複実行が防止されることを確認。
3. 最初の処理が完了した後、さらに新しいシェルを起動した際には、（スタンプファイルにより）当日分がスキップされることを確認。

## 補足

以前からお使いの「1日1回」の判定（スタンプファイル）はそのまま有効ですので、二つ目のシェルが立ち上がった際、一つ目が終わっていればスタンプを見てスキップし、実行中であればロックを見てスキップするようになります。
