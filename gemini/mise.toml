[env]
PROFILES_DIR = "profiles"
# WSL ç’°å¢ƒãªã‚‰ true ã«ãªã‚‹
IS_WSL = '''{% if
os() == 'linux' and exec(
  command="bash -c 'if grep -qi microsoft /proc/version 2>/dev/null || [ -n ${WSL_DISTRO_NAME:-} ]; then echo 0; else echo 1; fi'",
  allow_failure=true
) == "0" %}true{% else %}false{% endif %}'''

[tasks.check_env]
description = "ç’°å¢ƒå¤‰æ•°ãŒã¡ã‚ƒã‚“ã¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹"
quiet = true
hide = true
shell = "bash -c"
run = """
set -eu

# mise.local.tomlãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨åˆæœŸåŒ–
if [ ! -e "{{env.MISE_CONFIG_ROOT}}/mise.local.toml" ]; then
  {
    printf "%s\n" '[env]'
    printf "%s\n" 'DEFAULT_GEMINI_PROFILE=""'
    printf "%s\n" 'WSL_GEMINI_PROFILE=""'
  } > "{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
  printf "%s\n" "ğŸš¨ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
  printf "%s\n" "ğŸš¨ å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"
  printf "%s\n" "ğŸš¨ DEFAULT_GEMINI_PROFILE=\"\" ã¨ WSL_GEMINI_PROFILE=\"\" ã«é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
if [ -z "${DEFAULT_GEMINI_PROFILE:-}" ]; then
  printf "%s\n" "ğŸš¨ 'DEFAULT_GEMINI_PROFILE' ã‚’ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
if [ -z "${WSL_GEMINI_PROFILE:-}" ]; then
  printf "%s\n" "ğŸš¨ 'WSL_GEMINI_PROFILE' ã‚’ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚ï¼ˆwsl ã‚’åˆ©ç”¨ã—ãªã„å ´åˆã§ã‚‚ä½•ã‚‰ã‹ã®å€¤ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼‰"
  exit 1
fi

# ~/.gemini ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã™ã‚‹
if [ ! -d "${HOME}/.gemini" ]; then
  mkdir -p "${HOME}/.gemini"
fi
"""

[tasks.check]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
depends = ["check_env"]
hide = true
quiet = true
shell = "bash -c"
run = """
{% if env.IS_WSL == 'true' %}
DEFAULT_PROFILE="{{ env.WSL_GEMINI_PROFILE }}"
{% else %}
DEFAULT_PROFILE="{{ env.DEFAULT_GEMINI_PROFILE }}"
{% endif %}
PROFILE=$([ -n "{{option(name="prof")}}" ] && echo "{{option(name="prof")}}" || echo "$DEFAULT_PROFILE")
printf "Using profile: \\033[36m%s\\033[0m\n" "$PROFILE"
if [ -z "$PROFILE" ]; then
  printf "âŒ Error: DEFAULT_GEMINI_PROFILE is not set in environment variables\n" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

if [ ! -d "$PROFILE_PATH" ]; then
  {
    printf "âŒ Error: Profile directory '$PROFILE_PATH' does not exist\n"
    printf "   Available profiles:\n"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      printf "   (No profiles directory found)\n"
    fi
  } >&2
  exit 1
fi
"""

[tasks.create_profile]
description = "æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ (Usage: mise run create_profile <profile-name>)"
depends = ["check_env"]
shell = "bash -c"
quiet = true
run = """
PROFILE={{arg(name="prof")}}
if [ -z "$PROFILE" ]; then
  {
    printf "âŒ Error: profile name is required.\n"
    printf "   Usage: mise run create_profile <profile-name>\n"
  } >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
if [ -d "$PROFILE_PATH" ]; then
  printf "âŒ Error: Profile '$PROFILE' already exists\n" >&2
  exit 1
fi

printf "ğŸ¦„ Creating new Gemini CLI profile: $PROFILE\n"
mkdir -p "$PROFILE_PATH"

printf "%s\n" "âœ… Created profile '$PROFILE' at $PROFILE_PATH"
"""

[tasks.link]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã™ã‚‹"
depends = ["check_env"]
shell = "bash -c"
quiet = true
run = """
{% if env.IS_WSL == 'true' %}
DEFAULT_PROFILE="{{ env.WSL_GEMINI_PROFILE }}"
{% else %}
DEFAULT_PROFILE="{{ env.DEFAULT_GEMINI_PROFILE }}"
{% endif %}
PROFILE=$([ -n "{{option(name="prof")}}" ] && echo "{{option(name="prof")}}" || echo "$DEFAULT_PROFILE")
mise run check --prof "$PROFILE"

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

printf "%s\n" "ğŸ¦„ Linking Gemini CLI settings from profile: $PROFILE"

# æ—¢å­˜ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯é€€é¿ï¼‰
for file in commands GEMINI.md antigravity/global_workflows; do
  target="${HOME}/.gemini/$file"
  if [ -L "$target" ]; then
    printf "%s\n" "   Removing existing symlink: $target"
    rm "$target"
  elif [ -e "$target" ]; then
    backup="${target}.backup.$(date +%Y%m%d_%H%M%S)"
    printf "%s\n" "   æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ: $target -> $backup"
    mv "$target" "$backup"
  fi
done

# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ
for file in commands GEMINI.md antigravity/global_workflows; do
  source="$PROFILE_PATH/$file"
  target="${HOME}/.gemini/$file"

  # è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆãƒã‚¹ãƒˆã—ãŸãƒ‘ã‚¹ç”¨ï¼‰
  mkdir -p "$(dirname "$target")"

  if [ -e "$source" ]; then
    printf "\\033[36m  "
    ln -sfnv "$source" "$target"
    printf "\\033[0m"
  else
    printf "   âš ï¸  Skipping missing file: \\033[31m%s\\033[0m\n" "$source"
  fi
done

printf "%s\n" "âœ… Linked Gemini CLI settings from profile '$PROFILE'"
"""

[tasks.status]
description = "ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã¨~/.geminiã®çŠ¶æ…‹ã‚’ç¢ºèª"
depends = ["check_env"]
shell = "bash -c"
quiet = true
run = """
{% if env.IS_WSL == 'true' %}
DEFAULT_PROFILE="{{ env.WSL_GEMINI_PROFILE }}"
{% else %}
DEFAULT_PROFILE="{{ env.DEFAULT_GEMINI_PROFILE }}"
{% endif %}
PROFILE=$([ -n "{{option(name="prof")}}" ] && echo "{{option(name="prof")}}" || echo "$DEFAULT_PROFILE")

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

printf "%s\n" "ğŸ¦„ Environment Check"
printf "os()                 =\\033[36m %s\\033[0m\n" "{{ os() }}"
printf "env.IS_WSL           =\\033[36m %s\\033[0m\n" "{{ env.IS_WSL }}"
printf "env.MISE_CONFIG_ROOT =\\033[36m %s\\033[0m\n" "{{ env.MISE_CONFIG_ROOT }}"
printf "Selected profile     =\\033[36m %s\\033[0m\n" "$PROFILE"

if [ ! -d "$PROFILE_PATH" ]; then
  printf "âŒ Profile directory does not exist:\\033[36m %s\\033[0m\n" "$PROFILE_PATH"
  exit 1
fi

printf "\nğŸ“‚ Original files:\n"
for file in commands GEMINI.md antigravity/global_workflows; do
  source="$PROFILE_PATH/$file"
  if [ -e "$source" ]; then
    printf "%s\n" "   âœ… $source"
  else
    printf "\\033[31m%s\\033[0m\n" "   âŒ $source (missing)"
  fi
done

printf "\nğŸ”— Symlinks in\\033[36m %s/.gemini:\\033[0m\n" "$HOME"
for file in commands GEMINI.md antigravity/global_workflows; do
  target="${HOME}/.gemini/$file"
  source="$PROFILE_PATH/$file"

  if [ -L "$target" ]; then
    link_target=$(readlink "$target")
    # ãƒ‘ã‚¹ã®æ­£è¦åŒ–ã¨ãƒãƒƒãƒãƒ³ã‚°ï¼ˆWindows, WSLå¯¾å¿œï¼‰
    if [ "$link_target" = "$source" ] || [[ "$link_target" == */"${source##*/}" ]] || [[ "$link_target" == *"\\${source##*/}" ]]; then
      printf "%s\n" "   âœ… $source -> $link_target"
    else
      printf "%s\n" "   âš ï¸  $source -> $link_target (ä¸ä¸€è‡´)"
    fi
  elif [ -e "$target" ]; then
    printf "%s\n" "   âŒ $file (é€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§ã¯ãªã„). Use the following command â†“"
    printf "\\033[36m%s\\033[0m\n" "         code '$source' '$target'"
  else
    printf "\\033[33m%s\\033[0m\n" "   âŒ $target does not exist"
  fi
done

printf "%s\n" "\nğŸ’¡ Commands:"
printf "%s\n" "   ãƒªãƒ³ã‚¯ä½œæˆ/æ›´æ–°: mise run link --prof \"$PROFILE\""
printf "%s\n" "   ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´: mise run switch <profile-name>"
"""

[tasks.switch]
description = "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’æ›´æ–° (Usage: mise run switch <profile-name>)"
depends = ["check_env"]
shell = "bash -c"
quiet = true
run = """
NEW_PROFILE={{arg(name="prof")}}
if [ -z "$NEW_PROFILE" ]; then
  {
    printf "%s\n" "âŒ Error: profile name is required."
    printf "%s\n" "   Usage: mise run switch <profile-name>\n"
    printf "%s\n" "   Available profiles:"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/     - /'
    fi
  } >&2
  exit 1
fi

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
mise run check --prof "$NEW_PROFILE"

# WSL ã‹å¦ã‹ã«å¿œã˜ã¦ mise.local.toml ã®é©åˆ‡ãªç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
LOCAL_CONFIG="{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
{% if env.IS_WSL == 'true' %}
{
  printf "%s\n" '[env]'
  printf "%s\n" "DEFAULT_GEMINI_PROFILE = \\\"${DEFAULT_GEMINI_PROFILE:-}\\\""
  printf "%s\n" "WSL_GEMINI_PROFILE = \\\"$NEW_PROFILE\\\""
} > "$LOCAL_CONFIG"
{% else %}
{
  printf "%s\n" '[env]'
  printf "%s\n" "DEFAULT_GEMINI_PROFILE = \\\"$NEW_PROFILE\\\""
  printf "%s\n" "WSL_GEMINI_PROFILE = \\\"${WSL_GEMINI_PROFILE:-}\\\""
} > "$LOCAL_CONFIG"
{% endif %}

printf "%s\n" "ğŸ¦„ Switching Gemini CLI profile to: $NEW_PROFILE"

# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
mise run link --prof "$NEW_PROFILE"

printf "%s\n" "âœ… Switched to profile '$NEW_PROFILE'"
printf "%s\n" "ğŸ”„ Please restart your shell or run 'mise env' to reload environment variables"
"""

[tasks.list]
description = "åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º"
depends = ["check_env"]
shell = "bash -c"
quiet = true
run = """
PROFILES_DIR="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}"

{% if env.IS_WSL == 'true' %}
CURRENT_PROFILE="{{ env.WSL_GEMINI_PROFILE }}"
{% else %}
CURRENT_PROFILE="{{ env.DEFAULT_GEMINI_PROFILE }}"
{% endif %}

printf "%s\n" "ğŸ¦„ Available Gemini CLI Profiles:"
if [ -d "$PROFILES_DIR" ]; then
  for profile in "$PROFILES_DIR"/*; do
    if [ -d "$profile" ]; then
      profile_name=$(basename "$profile")
      if [ "$profile_name" = "$CURRENT_PROFILE" ]; then
        printf "%s\n" "   âœ… $profile_name (current)"
      else
        printf "%s\n" "   â­• $profile_name"
      fi
    fi
  done
else
  printf "%s\n" "   (No profiles found)"
fi

if [ -n "$CURRENT_PROFILE" ]; then
  printf "\nCurrent profile:\\033[36m %s\\033[0m\n" "$CURRENT_PROFILE"
else
  printf "%s\n" "\nâš ï¸ No current profile set in DEFAULT_GEMINI_PROFILE"
fi
"""
