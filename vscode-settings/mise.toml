[vars]
config_files = "settings.json keybindings.json tasks.json snippets"
vscode_path_mac = "$HOME/Library/Application Support/Code/User"
vscode_path_win = "$HOME/AppData/Roaming/Code/User"
cursor_path_mac = "$HOME/Library/Application Support/Cursor/User"
cursor_path_win = "$HOME/AppData/Roaming/Cursor/User"
agy_path_mac = "$HOME/Library/Application Support/Antigravity/User"
agy_path_win = "$HOME/AppData/Roaming/Antigravity/User"

[env]
VSCODE_PATH = "{% if os() == 'windows' %}{{vars.vscode_path_win}}{% else %}{{vars.vscode_path_mac}}{% endif %}"
CURSOR_PATH = "{% if os() == 'windows' %}{{vars.cursor_path_win}}{% else %}{{vars.cursor_path_mac}}{% endif %}"
AGY_PATH = "{% if os() == 'windows' %}{{vars.agy_path_win}}{% else %}{{vars.agy_path_mac}}{% endif %}"
PROFILE_ROOT = "{{config_root}}/profiles"

[tasks.ensure_local_env]
description = "mise.local.toml ã§ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹"
quiet = true
hide = true
shell = "bash -c"
run = """
set -eu
if [ ! -e "{{env.MISE_CONFIG_ROOT}}/mise.local.toml" ]; then
  {
    echo '[env]'
    echo 'DEFAULT_PROFILE=""'
  } > "{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
  echo "ğŸš¨ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
  echo "ğŸš¨ DEFAULT_PROFILE=\"\" ã«é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
if [ -z "${DEFAULT_PROFILE:-}" ]; then
  echo "ğŸš¨ 'DEFAULT_PROFILE' ã‚’ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
"""

[tasks.vars]
description = "å¤‰æ•°ã®å€¤ã‚’è¡¨ç¤º"
shell = "bash -c"
depends = ["ensure_local_env"]
run = '''
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
printf "PROFILE                = \033[36m$PROFILE\033[0m\n"
printf "Detected OS (uname -s) = \033[36m$(uname -s)\033[0m\n"
printf "PROFILE_ROOT           = \033[36m%s\033[0m\n" "{{env.PROFILE_ROOT}}"
printf "VSCODE_PATH            = \033[36m$VSCODE_PATH\033[0m\n"
printf "CURSOR_PATH            = \033[36m$CURSOR_PATH\033[0m\n"
printf "AGY_PATH               = \033[36m$AGY_PATH\033[0m\n"
printf "CONFIG_FILES           = \033[36m%s\033[0m\n" "{{vars.config_files}}"
'''

[tasks.dump]
description = "dump-settings ã¨ dump-extensions ã‚’ã¾ã¨ã‚ã¦å®Ÿè¡Œã™ã‚‹"
shell = "bash -c"
depends = ["ensure_local_env"]
run = """
EDITOR="{{arg(name="editor", default="vscode", choices=["vscode", "cursor", "antigravity"])}}"
mise run dump-settings $EDITOR
mise run dump-extensions vscode
mise run dump-extensions cursor
mise run dump-extensions antigravity
printf "âœ… ã™ã¹ã¦ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ!\n"
"""

[tasks.dump-settings]
description = "å„ç¨®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹"
shell = "bash -c"
hide = true
depends = ["ensure_local_env"]
run = """
EDITOR="{{arg(name="editor", default="vscode", choices=["vscode", "cursor", "antigravity"])}}"
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
PROFILE_DIR="{{env.PROFILE_ROOT}}/$PROFILE"
if [[ "$EDITOR" = "vscode" ]]; then
  src_path="{{env.VSCODE_PATH}}"
elif [[ "$EDITOR" = "cursor" ]]; then
  src_path="{{env.CURSOR_PATH}}"
elif [[ "$EDITOR" = "antigravity" ]]; then
  src_path="{{env.AGY_PATH}}"
else
  printf "  âŒ ä¸æ˜ãªã‚¨ãƒ‡ã‚£ã‚¿: $EDITOR\n"
  exit 1
fi

printf "ğŸ› ï¸  ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®šã‚’ \\033[36m${src_path}\\033[0m ã‹ã‚‰ \\033[36m%s\\033[0m ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™\n" "$PROFILE_DIR"
mkdir -p "$PROFILE_DIR"
for item in {{vars.config_files}}; do
  if [ -f "$src_path/$item" ] || [ -d "$src_path/$item" ]; then
    cp -r "$src_path/$item" "$PROFILE_DIR"
    printf "  âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: \\033[36m$src_path/$item -> %s/$item\\033[0m\n" "$PROFILE_DIR"
  else
    printf "  âš ï¸  ã‚¹ã‚­ãƒƒãƒ—: \\033[36m%s\\033[0m ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n" "$src_path/$item"
  fi
done
"""

[tasks.dump-extensions]
description = "æ‹¡å¼µæ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’ txt ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹"
shell = "bash -c"
hide = true
depends = ["ensure_local_env"]
run = """
EDITOR="{{arg(name="editor", default="vscode", choices=["vscode", "cursor", "antigravity"])}}"
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
PROFILE_DIR="{{env.PROFILE_ROOT}}/$PROFILE"
if [[ "$EDITOR" = "vscode" ]] || [[ "$EDITOR" = "cursor" ]]; then
  dist_path="$PROFILE_DIR/${EDITOR}_extensions.txt"
elif [[ "$EDITOR" = "antigravity" ]]; then
  dist_path="$PROFILE_DIR/antigravity_extensions.txt"
else
  printf "  âŒ ä¸æ˜ãªã‚¨ãƒ‡ã‚£ã‚¿: $EDITOR\n"
  exit 1
fi

printf "ğŸ› ï¸  æ‹¡å¼µæ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’ \\033[36m%s\\033[0m ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™\n" "$dist_path"
if [[ -e "$dist_path" ]]; then
  printf "  âš ï¸  æ—¢å­˜ã®æ‹¡å¼µæ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’ä¸Šæ›¸ãã—ã¾ã™: \\033[36m%s\\033[0m\n" "$dist_path"
  read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm
  if [[ "$confirm" != "y" ]]; then
    exit 0
  fi
fi

if [[ "$EDITOR" = "vscode" ]]; then
  if command -v code >/dev/null 2>&1; then
    printf "  ğŸ” ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆ: \\033[36m%s\\033[0m\n" "$dist_path"
    code --list-extensions | sort -u | uniq > "$dist_path"
  else
    printf "  âŒ ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:\\033[36m code\\033[0m\n"
    exit 0
  fi
elif [[ "$EDITOR" = "cursor" ]]; then
  if command -v cursor >/dev/null 2>&1; then
    printf "  ğŸ” ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆ: \\033[36m%s\\033[0m\n" "$dist_path"
    cursor --list-extensions | sort -u | uniq > "$dist_path"
  else
    printf "  âŒ ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:\\033[36m cursor\\033[0m\n"
    exit 0
  fi
else
  if command -v agy >/dev/null 2>&1; then
    printf "  ğŸ” ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆ: \\033[36m%s\\033[0m\n" "$dist_path"
    agy --list-extensions | sort -u | uniq > "$dist_path"
  else
    printf "  âŒ ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:\\033[36m agy\\033[0m\n"
    exit 0
  fi
fi

printf "  âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†!\n"
"""

[tasks.status]
description = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨æ‹¡å¼µæ©Ÿèƒ½ã®åŒæœŸçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹"
shell = "bash -c"
depends = ["ensure_local_env"]
run = """
mise run status-settings
mise run status-extensions
printf "\nâœ… ã™ã¹ã¦ã®çŠ¶æ…‹ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ!\n"
"""

[tasks.status-settings]
description = "å„ç¨®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®åŒæœŸçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹"
shell = "bash -c"
hide = true
depends = ["ensure_local_env"]
run = '''
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}

normalize_path() {
  local path="$1"
  # ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«å¤‰æ›
  path="${path//\\\\/\/}"

  # Windowså½¢å¼ã®ãƒ‰ãƒ©ã‚¤ãƒ–æ–‡å­— (C:) ã‚’ POSIXå½¢å¼ (/c) ã«å¤‰æ›
  if [[ "$path" =~ ^([A-Za-z]): ]]; then
    local drive="${BASH_REMATCH[1],,}"  # å°æ–‡å­—åŒ–
    path="/$drive${path:2}"
  fi

  # é€£ç¶šã™ã‚‹ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å˜ä¸€ã«ï¼ˆsedä½¿ç”¨ã§ã‚ˆã‚Šå®‰å…¨ã«ï¼‰
  path="$(echo "$path" | sed 's|//*|/|g')"

  # æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ãªã„å ´åˆï¼‰
  if [[ "$path" != "/" ]]; then
    path="${path%/}"
  fi

  echo "$path"
}

PROFILE_DIR="$(normalize_path "{{env.PROFILE_ROOT}}")/$PROFILE"

# ç’°å¢ƒå¤‰æ•°ã‚’å±•é–‹ã—ã¦ã‹ã‚‰æ­£è¦åŒ–
VSCODE_PATH_EXPANDED="$(echo "{{env.VSCODE_PATH}}" | envsubst)"
CURSOR_PATH_EXPANDED="$(echo "{{env.CURSOR_PATH}}" | envsubst)"
AGY_PATH_EXPANDED="$(echo "{{env.AGY_PATH}}" | envsubst)"
VSCODE_PATH_NORM="$(normalize_path "$VSCODE_PATH_EXPANDED")"
CURSOR_PATH_NORM="$(normalize_path "$CURSOR_PATH_EXPANDED")"
AGY_PATH_NORM="$(normalize_path "$AGY_PATH_EXPANDED")"

for editor_path in "$VSCODE_PATH_NORM" "$CURSOR_PATH_NORM" "$AGY_PATH_NORM"; do
  printf "\nSettings for\\033[36m %s\\033[0m\n" "${editor_path/ /\\ /}"
  for item in {{vars.config_files}}; do
    expected_src="$PROFILE_DIR/$item"
    dest_file="$editor_path/$item"
    if [ ! -e "$dest_file" ] && [ ! -L "$dest_file" ]; then
      printf "  â” %s: Not exists\n" "$item"
      elif [ -L "$dest_file" ]; then
      actual_src=$(readlink "$dest_file")
      if [ "$(normalize_path "$actual_src")" = "$(normalize_path "$expected_src")" ]; then
        printf "  âœ… %s <- %s\n" "$item" "$actual_src"
      else
        printf "  âŒ %s: Linked to a different source: %s\n" "$item" "$actual_src"
      fi
    else
      if [ -f "$dest_file" ] && [ -f "$expected_src" ]; then
        if diff -q "$dest_file" "$expected_src" >/dev/null; then
          printf "  âš ï¸  %s: Same content but not a symlink\n" "$item"
        else
          printf "  ğŸš¨ %s: Different from profile\n" "$item"
        fi
        elif [ -d "$dest_file" ] && [ -d "$expected_src" ]; then
        if diff -r -q "$dest_file" "$expected_src" >/dev/null 2>&1; then
          printf "  âš ï¸  %s: Same content but not a symlink\n" "$item"
        else
          printf "  ğŸš¨ %s: Different from profile\n" "$item"
        fi
      else
        printf "  ğŸš¨ %s: Not a symlink and cannot compare contents\n" "$item"
      fi
    fi
  done
done
'''

[tasks.status-extensions]
description = "æ‹¡å¼µæ©Ÿèƒ½ã®åŒæœŸçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹"
shell = "bash -c"
hide = true
depends = ["ensure_local_env"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
PROFILE_DIR="{{env.PROFILE_ROOT}}/$PROFILE"
for editor in vscode cursor agy; do
  if [[ "$editor" = "vscode" ]]; then
    ext_cmd="code"
    ext_file="$PROFILE_DIR/vscode_extensions.txt"
  elif [[ "$editor" = "agy" ]]; then
    ext_cmd="agy"
    ext_file="$PROFILE_DIR/antigravity_extensions.txt"
  else
    ext_cmd="cursor"
    ext_file="$PROFILE_DIR/cursor_extensions.txt"
  fi

  printf "\nExtensions for \\033[36m%s\\033[0m\n" "$editor"

  if [ ! -f "$ext_file" ]; then
    printf "  â” No extensions file found at \\033[36m%s\\033[0m\n" "$ext_file"
    continue
  fi

  if ! command -v "$ext_cmd" >/dev/null 2>&1; then
    printf "  âŒ Command not found: \\033[36m%s\\033[0m\n" "$ext_cmd"
    continue
  fi

  TEMP_DIR=${TEMP:-/tmp}
  RANDOM_SUFFIX=$(date +%s)
  INSTALLED_EXTS="$TEMP_DIR/${editor}_exts_$RANDOM_SUFFIX.txt"
  TO_INSTALL_EXTS="$TEMP_DIR/${editor}_to_install_$RANDOM_SUFFIX.txt"

  $ext_cmd --list-extensions > "$INSTALLED_EXTS" 2>/dev/null || true
  grep -Fxvf "$INSTALLED_EXTS" "$ext_file" > "$TO_INSTALL_EXTS" 2>/dev/null || true
  EXTRA_EXTS=$(grep -Fxvf "$ext_file" "$INSTALLED_EXTS" 2>/dev/null || true)

  if [ -s "$TO_INSTALL_EXTS" ]; then
    printf "  ğŸš¨ Extensions to install:\n"
    while IFS= read -r ext; do
      if [ -n "$ext" ]; then
        printf "    - %s\n" "$ext"
      fi
    done < "$TO_INSTALL_EXTS"
  else
    printf "  âœ… All extensions are installed\n"
  fi

  if [[ -n "$EXTRA_EXTS" ]]; then
    printf "  âš ï¸  Extra installed extensions not in profile:\n"
    while IFS= read -r ext; do
      if [ -n "$ext" ]; then
        printf "    - %s\n" "$ext"
      fi
    done <<< "$EXTRA_EXTS"
    read -p "  profile ã«æ›¸ã‹ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’è¿½è¨˜ã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm
    if [[ "$confirm" = "y" ]] || [[ "$confirm" = "Y" ]]; then
      $ext_cmd --list-extensions | sort -u | uniq > "$ext_file"
      printf "  âœ… æ‹¡å¼µæ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ: \\033[36m%s\\033[0m\n" "$ext_file"
    fi
  fi

  rm -f "$INSTALLED_EXTS" "$TO_INSTALL_EXTS" 2>/dev/null || true
done
"""

[tasks.sync]
description = "VS Code ã¨ Cursor ã®è¨­å®šã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã¨ã—ã¦åŒæœŸã—ã€æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹"
shell = "bash -c"
depends = ["ensure_local_env"]
run = """
mise run sync-settings
mise run sync-extensions
"""

[tasks.sync-settings]
description = "VS Code ã¨ Cursor ã®è¨­å®šã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã¨ã—ã¦åŒæœŸã™ã‚‹"
shell = "bash -c"
hide = true
depends = ["ensure_local_env"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
PROFILE_DIR="{{env.PROFILE_ROOT}}/$PROFILE"

if [ ! -d "$PROFILE_DIR" ]; then
  echo "âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $PROFILE_DIR"
  exit 1
fi

for editor_path in "{{env.VSCODE_PATH}}" "{{env.CURSOR_PATH}}" "{{env.AGY_PATH}}"; do
  printf "\nè¨­å®šé©ç”¨å…ˆ:\\033[36m %s\\033[0m\n" "$(echo $editor_path | sed 's/ /\\\\ /g')"
  if [ ! -d "$editor_path" ]; then
    mkdir -p "$editor_path"
  fi

  for item in {{vars.config_files}}; do
    src_item=$(realpath "$PROFILE_DIR/$item" 2>/dev/null || echo "")
    dest_item="$editor_path/$item"
    if [ -z "$src_item" ] || [ ! -e "$src_item" ]; then
      printf "  âš ï¸  ã‚¹ã‚­ãƒƒãƒ—: \\033[36m%s\\033[0m ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n" "$PROFILE_DIR/$item"
      elif [ -e "$dest_item" ] && ! [ -L "$dest_item" ]; then
      printf "  æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç™ºè¦‹: \\033[36m%s\\033[0m (ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§ãªã„)\n" "$dest_item"
      if diff -r -q "$src_item" "$dest_item" >/dev/null 2>&1; then
        printf "  âœ… å†…å®¹ãŒåŒä¸€ã§ã™ã€‚ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã«ç½®ãæ›ãˆã¾ã™: \\033[36m%s\\033[0m\n" "$PROFILE_DIR/$item"
        rm -rf "$dest_item"
        ln -snf "$src_item" "$dest_item"
      else
        printf "  âŒ ç«¶åˆ: æ‰‹å‹•ã§è§£æ±ºã—ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„\n"
        printf "     ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«: \\033[36m%s\\033[0m != æ—¢å­˜: \\033[36m%s\\033[0m\n" "$PROFILE_DIR/$item" "$dest_item"
      fi
    else
      ln -snf "$src_item" "$dest_item"
      printf "  âœ… ãƒªãƒ³ã‚¯å®Œäº†: \\033[36m%s\\033[0m\n" "$PROFILE_DIR/$item"
    fi
  done
done
printf "\nâœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼\n"
"""

[tasks.sync-extensions]
description = "VS Code ã¨ Cursor ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’åŒæœŸã™ã‚‹"
shell = "bash -c"
hide = true
depends = ["ensure_local_env"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
PROFILE_DIR="{{env.PROFILE_ROOT}}/$PROFILE"

for editor in vscode cursor agy; do
  if [[ "$editor" = "vscode" ]]; then
    ext_cmd="code"
    ext_file="$PROFILE_DIR/vscode_extensions.txt"
  elif [[ "$editor" = "agy" ]]; then
    ext_cmd="agy"
    ext_file="$PROFILE_DIR/antigravity_extensions.txt"
  else
    ext_cmd="cursor"
    ext_file="$PROFILE_DIR/cursor_extensions.txt"
  fi

  printf "\nSync Extensions for \\033[36m%s\\033[0m\n" "$editor"

  if [ ! -f "$ext_file" ]; then
    printf "  â” No extensions file found at \\033[36m%s\\033[0m\n" "$ext_file"
    continue
  fi

  if ! command -v "$ext_cmd" >/dev/null 2>&1; then
    printf "  âŒ Command not found: \\033[36m%s\\033[0m\n" "$ext_cmd"
    continue
  fi

  TEMP_DIR=${TEMP:-/tmp}
  RANDOM_SUFFIX=$(date +%s)
  INSTALLED_EXTS="$TEMP_DIR/vscode_exts_$RANDOM_SUFFIX.txt"
  $ext_cmd --list-extensions > "$INSTALLED_EXTS" 2>/dev/null || true
  extensions_to_install=$(grep -Fxvf "$INSTALLED_EXTS" "$ext_file" | tr '\n' ' ')
  extra_exts=$(grep -Fxvf "$ext_file" "$INSTALLED_EXTS" 2>/dev/null || true)

  if [ -n "$extensions_to_install" ]; then
    echo "  ğŸš¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ‹¡å¼µæ©Ÿèƒ½:"
    for ext in $extensions_to_install; do
      printf "    - %s\n" "$ext"
      $ext_cmd --install-extension "$ext" --force >/dev/null 2>&1 || true
    done
    printf "  âœ… æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n"
  else
    echo "  âœ… ã™ã¹ã¦ã®æ‹¡å¼µæ©Ÿèƒ½ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
  fi

  if [[ -n "$extra_exts" ]]; then
    echo "  âš ï¸  profile ã«æ›¸ã‹ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™:"
    while IFS= read -r ext; do
      if [ -n "$ext" ]; then
        printf "    - %s\n" "$ext"
      fi
    done <<< "$extra_exts"
    read -p "  profile ã«æ›¸ã‹ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’è¿½è¨˜ã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm
    if [[ "$confirm" = "y" ]] || [[ "$confirm" = "Y" ]]; then
      $ext_cmd --list-extensions >> "$ext_file"
      cat "$ext_file" | sort -u | uniq > "$ext_file".tmp
      mv "$ext_file".tmp "$ext_file"
      printf "  âœ… æ‹¡å¼µæ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ: \\033[36m%s\\033[0m\n" "$ext_file"
    fi
  fi
  rm -f "$INSTALLED_EXTS" 2>/dev/null || true
done
printf "\nâœ… æ‹¡å¼µæ©Ÿèƒ½ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼\n"
"""
