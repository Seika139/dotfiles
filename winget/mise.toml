[tasks.check_env]
description = "ç’°å¢ƒå¤‰æ•°ãŒã¡ã‚ƒã‚“ã¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹"
quiet = true
hide = true
shell = "bash -c"
run = """
set -eu
if [ ! -e "{{env.MISE_CONFIG_ROOT}}/mise.local.toml" ]; then
  {
    echo '[env]'
    echo 'PROFILES_DIR="profiles"'
    echo 'PACKAGE_IDS = "package-ids.txt"'
    echo 'EXPORT_JSON = "winget-export.json"'
    echo 'DEFAULT_PROFILE=""'
  } > "{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
  echo "ğŸš¨ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
  echo "ğŸš¨ å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"
  echo "ğŸš¨ DEFAULT_PROFILE=\"\" ã«é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
if [ -z "${DEFAULT_PROFILE:-}" ]; then
  echo "ğŸš¨ 'DEFAULT_PROFILE' ã‚’ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi
"""

[tasks.winget_available]
description = "winget ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
quiet = true
hide = true
shell = "bash -c"
run = """
if ! command -v winget >/dev/null 2>&1; then
  echo "âŒ Error: winget command not found. Please install Winget." >&2
  exit 1
fi
"""

[tasks.check]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
depends = ["check_env"]
hide = true
quiet = true
shell = "bash -c"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
if [ -z "$PROFILE" ]; then
  printf "âŒ Error: DEFAULT_PROFILE is not set in environment variables\n" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

# æˆåŠŸæ™‚ã¯ç„¡éŸ³ã€ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹
if [ ! -d "$PROFILE_PATH" ]; then
  {
    printf "âŒ Error: Profile directory '$PROFILE_PATH' does not exist\n"
    printf "   Available profiles:\n"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      printf "   (No profiles directory found)\n"
    fi
  } >&2
  exit 1
fi
"""

[tasks.dump]
description = "ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ï¼ˆãŸã ã— update ãªã©ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã«åˆ©ç”¨ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ï¼‰"
shell = "bash -c"
depends = ["check_env", "winget_available"]
run = '''
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
printf "ğŸ¦„  Dumping current winget packages to profile: \033[36m$PROFILE\033[0m\n"
printf "âš ï¸ ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã©ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚‚åˆ©ç”¨ã§ãã¾ã›ã‚“ã€ã¨ã„ã†è­¦å‘ŠãŒå‡ºã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ç„¡è¦–ã—ã¦æ§‹ã„ã¾ã›ã‚“ã€‚\n"
mkdir -p "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
winget export -o "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.EXPORT_JSON}}"
printf "\nâœ…  Dumped current packages to \033[36m%s\033[36m\n" "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.EXPORT_JSON}}"
'''

[tasks.update]
description = "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²ã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹"
shell = "bash -c"
depends = ["check_env", "winget_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
EXPORT_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.PACKAGE_IDS}}"
if [ ! -f "$EXPORT_PATH" ]; then
  printf "âŒ Error: Export file not found at '$EXPORT_PATH'\n" >&2
  exit 1
fi
printf "ğŸ¦„ Update Packages\n"
printf "  \\033[36m$EXPORT_PATH \\033[0mã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦é †æ¬¡ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è©¦ã¿ã¾ã™\n"
printf "  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¶å¾¡ (UAC) ã®ç¢ºèªãŒå‡ºãŸã‚‰ã€Œã¯ã„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚\n"
printf "  UAC ã‚’å‡ºã•ãªã„ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€Git Bash ã‚’ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚\n\n"

packages=$(cat "$EXPORT_PATH")
for package in $packages; do
  printf "  winget upgrade --accept-source-agreements --accept-package-agreements --id \"$package\"\n"
  winget upgrade --accept-source-agreements --accept-package-agreements --id "$package"
done
"""

[tasks.show_update]
description = "winget update ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²ã—ã¦ã„ã‚‹ã‚‚ã®ã‚’å«ã‚€ã™ã¹ã¦ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹"
depends = "exec-winget-update"
shell = "bash -c"
quiet = true
run = """
echo
echo "ğŸ¦„ ç‰¹å®šã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
echo "  winget upgrade --accept-source-agreements --accept-package-agreements --id <package-id>"
"""

[tasks.exec-winget-update]
hide = true
quiet = true
shell = "bash -c"
run = "winget update --include-unknown"
