[tools]
python = "3.11.6"
uv = "latest"

#################################
# Environments and Dependencies #
#################################

[tasks.venv]
description = "uvを利用して仮想環境を作成します。ある場合はスキップされます"
shell = "bash -c"
quiet = true
run = '''
if [ ! -d "{{env.MISE_CONFIG_ROOT}}/.venv" ]; then
  echo "Creating .venv ..."
  uv venv --clear
fi
'''

[tasks.reset-venv]
description = "仮想環境をリセットします"
shell = "bash -c"
quiet = true
run = '''
echo "Resetting .venv ..."
venv_dir="{{env.MISE_CONFIG_ROOT}}/.venv"
if [ -d "$venv_dir" ]; then
  echo "Removing existing .venv ...";
  chmod -R +w "$venv_dir" 2>/dev/null || true;
  find "$venv_dir" -type l -delete 2>/dev/null || true;
  find "$venv_dir" -type f -exec chmod +w {} \; 2>/dev/null || true;
  rm -rf "$venv_dir" 2>/dev/null || sudo rm -rf "$venv_dir" || true;
fi
uv venv --clear
echo "done. Run 'mise run resolve' to sync dependencies."
'''

[tasks.resolve]
description = "依存関係を解決します"
shell = "bash -c"
quiet = true
depends = ["venv"]
run = '''
if [ -d "{{env.MISE_CONFIG_ROOT}}/.venv" ] \
  && [ ! -f "{{env.MISE_CONFIG_ROOT}}/.venv/bin/python" ] \
  && [ ! -f "{{env.MISE_CONFIG_ROOT}}/.venv/Scripts/python.exe" ]; then
  echo "virtual environment is broken. Recreating..."
  mise run reset-venv
fi

uv lock
uv sync

printf "✅ Dependencies are resolved.\n"
'''

[tasks.upgrade]
description = "依存関係を最新のバージョンにアップグレードします"
shell = "bash -c"
quiet = true
depends = ["venv"]
run = 'uv sync --upgrade'

################
# Code Quality #
################

[tasks.check]
description = "コードの静的解析とテストを実行します"
shell = "bash -c"
quiet = true
run = '''
printf "\033[33m%s\033[0m\n" "Running ruff check..."
uv run ruff check .
printf "\033[33m%s\033[0m\n" "Running mypy..."
uv run mypy .
printf "\033[33m%s\033[0m\n" "Running pytest..."
uv run pytest tests/
'''

[tasks.format]
description = "コードのフォーマットを実行します"
shell = "bash -c"
quiet = true
run = '''
printf "\033[33m%s\033[0m\n" "Running ruff format..."
uv run ruff format .
printf "\033[33m%s\033[0m\n" "Running ruff check --fix..."
uv run ruff check . --fix
'''

[tasks.ruff-clean]
description = "Ruffのキャッシュをクリアします"
shell = "bash -c"
quiet = true
run = '''
printf "\033[33m%s\033[0m\n" "Clearing ruff cache..."
uv run ruff cache clear
'''

########################
# Mouse Emulator Tasks #
########################

[tasks.register]
description = "マウスエミュレーターのプロファイルを作成します"
shell = "bash -c"
quiet = true
run = "uv run python -m mouse_emulator register {{option(name='prof', default='default')}}"

[tasks.emulate]
description = "マウスエミュレーターを実行します"
shell = "bash -c"
quiet = true
run = "uv run python -m mouse_emulator emulate {{option(name='prof', default='default')}}"

#######################
# Auto Emulator Tasks #
#######################

[tasks.auto-validate]
description = "自動エミュレーターの設定ファイルを検証します"
shell = "bash -c"
quiet = true
run = "uv run python -m auto_emulator validate {{option(name='config', default='profiles/auto_emulator/example.yml')}}"

[tasks.auto-run]
description = "自動エミュレーターを実行します"
shell = "bash -c"
quiet = true
run = "uv run python -m auto_emulator run {{option(name='config', default='profiles/auto_emulator/example.yml')}}"

[tasks.auto-probe]
description = "キャリブレーション後に相対座標をプローブします"
shell = "bash -c"
quiet = true
run = '''
uv run python -m auto_emulator probe --interval {{option(name='interval',default='0.5')}} --mode {{option(name='mode',default='click')}}
'''
