[tasks.container]
description = "コンテナに関する操作"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show-all", "show-deletable", "prune"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show-all\nshow-deletable\nprune\n" |
  fzf --height 7 --border --prompt "選択: " \
      --preview '
        case {} in
          show-all) printf "全コンテナを表示します\n" ;;
          show-deletable) printf "削除可能なコンテナを表示します\n" ;;
          prune) printf "停止中のコンテナを削除します\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show-all)
    printf "show-all: 全コンテナを表示します\n"
    printf "\\033[36m$ docker ps -a\\033[0m\n"
    docker ps -a
    ;;
  show-deletable)
    printf "show-deletable: 削除可能なコンテナを表示します\n\n"
    printf "\\033[36m$ docker ps -a -f status=exited\\033[0m # 停止中のコンテナ\n"
    docker ps -a -f status=exited
    printf "\n\\033[36m$ docker ps -a -f status=dead\\033[0m # 異常終了したコンテナ\n"
    docker ps -a -f status=dead
    ;;
  prune)
    printf "prune: 停止中のコンテナを削除します\n"
    printf "\\033[36m$ docker container prune --force\\033[0m\n"
    docker container prune --force
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""

[tasks.image]
description = "イメージに関する操作"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show-all", "show-deletable", "prune", "prune-all"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show-all\nshow-deletable\nprune\nprune-all\n" | fzf --height 8 --border --prompt "選択: " \
      --preview '
        case {} in
          show-all) printf "全イメージを表示します\n" ;;
          show-deletable) printf "削除可能なイメージを表示します\n" ;;
          prune) printf "タグづけされてないイメージ(dangling image)を削除します\n" ;;
          prune-all) printf "停止中のコンテナを含む全てのコンテナから参照されていないイメージを削除します\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show-all)
    printf "show-all: 全イメージを表示します\n"
    printf "\\033[36m$ docker image ls\\033[0m\n"
    docker image ls
    ;;
  show-deletable)
    printf "show-deletable: タグづけされてないイメージ(dangling image)を表示します\n\n"
    printf "\\033[36m$ docker images -f dangling=true\\033[0m\n"
    docker images -f dangling=true
    printf "\n"
    USED_IDS_FILE="$(mktemp)"
    {% raw %}
    docker ps -aq | xargs -r docker inspect -f '{{.Image}}' | sort -u > "$USED_IDS_FILE"
    {% endraw %}
    printf "\\033[36m未使用（docker image prune -a の削除対象）イメージ一覧\\033[0m\n"
    {% raw %}
    docker images --no-trunc \
      --format '{{.ID}}\\t{{.Repository}}:{{.Tag}}\\t{{.CreatedSince}}\\t{{.Size}}' \
    {% endraw %} \
    | awk -F '\\t' -v f="$USED_IDS_FILE" '
      BEGIN {
        while ((getline line < f) > 0) used[line]=1; close(f);
        print "IMAGE ID\tREPOSITORY:TAG\tCREATED\tSIZE"
        print "--------\t--------------\t-------\t----"
      }
      {
        id=$1;
        if (!(id in used)) printf "%s\\t%s\\t%s\\t%s\\n", $1,$2,$3,$4;
      }
    ' | column -t -s $'\t'
    rm -f "$USED_IDS_FILE"
    ;;
  prune)
    printf "prune: タグづけされてないイメージ(dangling image)を削除します\n"
    printf "\\033[36m$ docker image prune --force\\033[0m\n"
    docker image prune --force
    ;;
  prune-all)
    printf "prune-all: 停止中のコンテナを含む全てのコンテナから参照されていないイメージを削除します\n"
    printf "\\033[36m$ docker image prune --all --force\\033[0m\n"
    docker image prune --all --force
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""

[tasks.network]
description = "ネットワークに関する操作"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show-all", "show-deletable", "prune"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show-all\nshow-deletable\nprune\n" | fzf --height 7 --border --prompt "選択: " \
      --preview '
        case {} in
          show-all) printf "全ネットワークを表示します\n" ;;
          show-deletable) printf "削除可能なネットワークを表示します\n" ;;
          prune) printf "未使用のネットワークを削除します\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show-all)
    printf "show-all: 全ネットワークを表示します\n"
    printf "\\033[36m$ docker network ls\\033[0m\n"
    docker network ls
    ;;
  show-deletable)
    printf "show-deletable: 削除可能なネットワークを表示します\n\n"
    printf "\\033[36m削除対象のカスタムネットワーク（未使用）\\033[0m\n\n"
    # デフォルトネットワーク（bridge, host, none）を除外し、未使用のネットワークを表示
    printf "NETWORK ID\tNAME\n"
    printf "%s\n" "------------\t----"
    {% raw %}
    docker network ls --format "{{.ID}} {{.Name}}" | \
    {% endraw %} \
    while read -r network_id network_name; do
      case "$network_name" in
        bridge|host|none) continue ;;
      esac
      # ネットワークに接続されているコンテナを確認
      {% raw %}
      containers=$(docker network inspect "$network_id" --format '{{len .Containers}}' 2>/dev/null || echo "0")
      {% endraw %}
      if [ "$containers" = "0" ]; then
        printf "$network_id\t$network_name\n"
      fi
    done
    ;;
  prune)
    printf "prune: 未使用のネットワークを削除します\n"
    printf "\\033[36m$ docker network prune --force\\033[0m\n"
    docker network prune --force
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""

[tasks.volume]
description = "ボリュームに関する操作"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show-all", "show-deletable", "prune", "prune-all"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show-all\nshow-deletable\nprune\nprune-all\n" | fzf --height 8 --border --prompt "選択: " \
      --preview '
        case {} in
          show-all) printf "全ボリュームを表示します\n" ;;
          show-deletable) printf "削除可能なボリュームを表示します\n" ;;
          prune) printf "未使用の匿名ボリュームを削除します\n" ;;
          prune-all) printf "未使用の全ボリューム（名前付きも含む）を削除します\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show-all)
    printf "show-all: 全ボリュームを表示します\n"
    printf "\\033[36m$ docker volume ls\\033[0m\n"
    docker volume ls
    ;;
  show-deletable)
    printf "show-deletable: 削除可能なボリュームを表示します\n\n"
    printf "\\033[36m匿名ボリューム（mise run volume prune で削除）\\033[0m\n"
    printf "SIZE\tVOLUME NAME\n"
    printf "%s\n" "----\t-----------"
    # 匿名ボリューム（64文字のハッシュ）で未使用のもの
    docker system df -v | \
    awk '
      /^VOLUME NAME/ { in_volumes=1; next }
      in_volumes && NF>=3 {
        if ($2 == 0 && length($1) == 64 && $1 ~ /^[0-9a-f]+$/)
          print $3"\t"$1
      }
    '
    printf "\n\\033[36m名前付きボリューム（mise run volume prune-all でのみ削除）\\033[0m\n"
    printf "SIZE\tVOLUME NAME\n"
    printf "%s\n" "----\t-----------"
    # 名前付きボリュームで未使用のもの
    docker system df -v | \
    awk '
      /^VOLUME NAME/ { in_volumes=1; next }
      in_volumes && NF>=3 {
        if ($2 == 0 && !(length($1) == 64 && $1 ~ /^[0-9a-f]+$/))
          print $3"\t"$1
      }
    '
    ;;
  prune)
    printf "prune: 未使用の匿名ボリュームを削除します\n"
    printf "\\033[36m$ docker volume prune --force\\033[0m\n"
    docker volume prune --force
    ;;
  prune-all)
    printf "prune-all: 未使用の全ボリューム（名前付きも含む）を削除します\n"
    printf "\\033[36m$ docker volume prune --all --force\\033[0m\n"
    docker volume prune --all --force
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""

[tasks.buildx]
description = "Docker Buildx管理（ビルダー・キャッシュ）"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show-builders", "show-cache", "show-deletable-builders", "prune-builders", "prune-cache", "prune-cache-all"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show-builders\nshow-cache\nshow-deletable-builders\nprune-builders\nprune-cache\nprune-cache-all\n" | fzf --height 10 --border --prompt "選択: " \
      --preview '
        case {} in
          show-builders) printf "全ビルダーインスタンスを表示します\n" ;;
          show-cache) printf "ビルドキャッシュの使用状況を表示します\n" ;;
          show-deletable-builders) printf "削除可能なビルダーを表示します\n" ;;
          prune-builders) printf "デフォルト以外のビルダーを削除します\n" ;;
          prune-cache) printf "ビルドキャッシュを削除します（基本）\n" ;;
          prune-cache-all) printf "ビルドキャッシュを削除します（内部キャッシュ含む全て）\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show-builders)
    printf "show-builders: 全ビルダーインスタンスを表示します\n"
    printf "\\033[36m$ docker buildx ls\\033[0m\n"
    docker buildx ls
    ;;
  show-cache)
    printf "show-cache: ビルドキャッシュの使用状況を表示します\n"
    printf "\\033[36m$ docker buildx du\\033[0m\n"
    docker buildx du
    printf "\n\\033[33m注意: 表示されているキャッシュが prune-cache の削除対象です\\033[0m\n"
    printf "\\033[33m--all オプション無しでは内部キャッシュは保持されます\\033[0m\n\n"
    ;;
  show-deletable-builders)
    printf "show-deletable-builders: 削除可能なビルダーを表示します\n\n"
    printf "\\033[36m削除対象のビルダー（デフォルト以外）\\033[0m\n\n"
    docker buildx ls | awk '
      NR==1 { print; next }  # ヘッダー行をそのまま出力
      NR>1 {
        # ビルダー名（1列目）からアスタリスクを除去
        gsub(/\\*$/, "", $1)
        if ($1 != "default" && $1 != "desktop-linux") {
          print
        }
      }
    '
    ;;
  prune-builders)
    printf "prune-builders: デフォルト以外のビルダーを削除します\n\n"
    {% raw %}
    builders_to_delete=$(docker buildx ls --format '{{ .Name }}' | sed 's/\\*$//'  | sort | uniq | awk '$0!="default" && $0!="desktop-linux"')
    {% endraw %}
    if [ -z "$builders_to_delete" ]; then
      printf "削除対象のビルダーはありません\n"
    else
      printf "削除対象:\n"
      echo "$builders_to_delete"
      printf "$builders_to_delete\n\n"
      printf "\\033[36m$ docker buildx rm <builders>\\033[0m\n"
      printf "$builders_to_delete" | xargs -I {} docker buildx rm {} 2>/dev/null || printf "一部のビルダー削除に失敗しました\n"
    fi
    ;;
  prune-cache)
    printf "prune-cache: ビルドキャッシュを削除します（基本）\n"
    printf "\\033[36m$ docker buildx prune --force\\033[0m\n"
    docker buildx prune --force
    ;;
  prune-cache-all)
    printf "prune-cache-all: ビルドキャッシュを削除します（内部キャッシュ含む全て）\n"
    printf "\\033[36m$ docker buildx prune --all --force\\033[0m\n"
    docker buildx prune --all --force
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""

[tasks.context]
description = "Docker Context管理"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show", "show-deletable", "prune"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show\nshow-deletable\nprune\n" | fzf --height 7 --border --prompt "選択: " \
      --preview '
        case {} in
          show) printf "全コンテキストを表示します\n" ;;
          show-deletable) printf "削除可能なコンテキストを表示します\n" ;;
          prune) printf "システム以外のコンテキストを削除します\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show)
    printf "show: 全コンテキストを表示します\n"
    printf "\\033[36m$ docker context ls\\033[0m\n"
    docker context ls
    ;;
  show-deletable)
    printf "show-deletable: 削除可能なコンテキストを表示します\n\n"
    printf "\\033[36m削除対象のコンテキスト（システム以外）\\033[0m\n\n"
    printf "NAME\tENDPOINT\n"
    printf "%s\n" "----\t--------"
    {% raw %}
    docker context ls --format "{{.Name}}\t{{.DockerEndpoint}}" | \
    {% endraw %}
    while IFS=$'\t' read -r name endpoint; do
      case "$name" in
        default|desktop-linux) continue ;;
        *) printf "%s\t%s\n" "$name" "$endpoint" ;;
      esac
    done
    ;;
  prune)
    printf "prune: システム以外のコンテキストを削除します\n\n"
    {% raw %}
    contexts_to_delete=$(docker context ls --format "{{.Name}}" | awk '!/^(default|desktop-linux)$/')
    {% endraw %}
    if [ -z "$contexts_to_delete" ]; then
      printf "削除対象のコンテキストはありません\n"
    else
      printf "削除対象:\n"
      printf "$contexts_to_delete\n\n"
      printf "\\033[36m$ docker context rm <contexts>\\033[0m\n"
      printf "$contexts_to_delete\n" | xargs docker context rm 2>/dev/null || printf "一部のコンテキスト削除に失敗しました\n"
    fi
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""

[tasks.system]
description = "システム全体の管理"
shell = "bash -c"
run = """
selected_option={{arg(description="操作を選択してください", choices=["show", "prune"], default="")}}

if [ -z "${selected_option}" ]; then
  selected_option=$(
  printf "show\nprune\n" | fzf --height 6 --border --prompt "選択: " \
      --preview '
        case {} in
          show) printf "システム全体のリソース使用状況を表示します\n" ;;
          prune) printf "未使用リソースを一括削除します（ビルドキャッシュ除く）\n" ;;
        esac
      ' --preview-window=right,50%
  )
fi

case $selected_option in
  show)
    printf "show: システム全体のリソース使用状況を表示します\n"
    printf "\\033[36m$ docker system df -v\\033[0m\n"
    docker system df -v
    printf "\n\\033[33m注意: ビルドキャッシュは 'mise run buildx prune-cache' で削除してください\\033[0m\n"
    ;;
  prune)
    printf "prune: 未使用リソースを一括削除します\n\n"
    printf "\\033[33m削除対象: 停止コンテナ + 未使用イメージ + 未使用ネットワーク + 未使用ボリューム\\033[0m\n"
    printf "\\033[33m注意: ビルドキャッシュは含まれません\\033[0m\n\n"
    printf "\\033[36m$ docker system prune --all --volumes --force\\033[0m\n"
    docker system prune --all --volumes --force
    ;;
  *)
    printf "無効なオプションです: $selected_option\n"
    exit 1
    ;;
esac
"""
