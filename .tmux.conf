######################
# プレフィックスの設定 #
######################

# prefixキーをC-aに変更する
set-option -g prefix C-a
bind-key C-a send-prefix

# デフォルトのprefixキーC-bを解除する
unbind-key C-b

# PREFIX + r で設定ファイルをリロードする
bind r source-file ~/.tmux.conf \; display "Reloaded!"

#############################
# ペイン分割のキーバインド設定 #
#############################

# prefix+|でペインを垂直分割する
bind | split-window -h

# prefix+-でペインを水平分割する
bind - split-window -v

######################
# ステータスバーの設定 #
######################

set -g status on
# 更新間隔が長いほど負荷が軽くなる
set -g status-interval 3

# prefix キーが押されたときにステータスバーの色を変更
# 通常時: 緑背景、prefix キー押下時: 赤背景
set -g status-style "#{?client_prefix,bg=red,bg=green},fg=black"

# ステータスバー左側に セッション名 と prefix インジケーターを表示
set -g status-left "[#S] #{?client_prefix,#[bg=red]#[fg=white]#[bold] PREFIX #[default] ,}"
set -g status-left-length 40

# ステータスバー右側に ペインタイトル、CPU/メモリ使用率を表示
# tmux では % を表示するために %% とエスケープが必要
# macOS (Darwin) の場合は memory_pressure を、Linux の場合は free を使用する
if-shell 'uname -s | grep -q Darwin' \
    'set -g status-right "#{=21:pane_title} | CPU: #(top -l 1 -n 0 | awk \"/CPU usage/ {print \\\$3 + \\\$5}\")%% | Mem: #(memory_pressure -Q | awk \"/System-wide memory free percentage/ {print 100 - \\\$5}\")%% "' \
    'set -g status-right "#{=21:pane_title} | CPU: #(top -bn1 | grep \"Cpu(s)\" | awk \"{print \\\$2}\")%% | Mem: #(free | grep Mem | awk \"{printf \\\"%.0f%%%%\\\", \\\$3/\\\$2 * 100}\") "'
set -g status-right-length 80

# ステータスバーのアクティブなウィンドウの色を白に変更する
set -g window-status-current-style 'bg=color231,fg=color016'

##############################
# マウス操作とコピーモード設定 #
##############################

# マウス操作を有効化
set -g mouse on

# クリップボード設定（Mac/WSL 自動判定）
# Mac (Darwin) なら pbcopy、WSL/Linux なら clip.exe を使用
if-shell 'uname -s | grep -q Darwin' \
    'set -s copy-command "pbcopy"' \
    'set -s copy-command "clip.exe"'

# コピーモード（選択範囲）のスタイル設定を視認しやすく
set -g mode-style "bg=yellow,fg=black,bold"

# マウスドラッグで選択範囲を維持（自動コピーしない）
# マウスを離したときに選択範囲を保持
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X stop-selection
bind-key -T copy-mode MouseDragEnd1Pane send-keys -X stop-selection

# コピーのキーバインド（複数の方法を提供）
# Ctrl+C でコピー
bind-key -T copy-mode-vi C-c send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode C-c send-keys -X copy-pipe-and-cancel

# Enter でコピー（最も確実）
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode Enter send-keys -X copy-pipe-and-cancel

# y でコピー（vi風）
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel

# Ctrl+Insert も試す（ターミナル次第で動作する可能性あるが Ubuntu では少なくとも動作しない）
bind-key -T copy-mode-vi C-Insert send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode C-Insert send-keys -X copy-pipe-and-cancel

# コピーモードを終了するには q か Escape を押す
