# ç’°å¢ƒå¤‰æ•°ã®å®šç¾©
[env]
PROFILES_DIR = "profiles"
BREWFILE_NAME = "Brewfile"
DEFAULT_PROFILE = "hm-m1-mac"

[tasks.vars]
description = "å¤‰æ•°ã®å€¤ã‚’è¡¨ç¤º"
quiet = true
run = """
echo "PROFILES_DIR    = {{env.PROFILES_DIR}}"
echo "BREWFILE_NAME   = {{env.BREWFILE_NAME}}"
echo "DEFAULT_PROFILE = {{env.DEFAULT_PROFILE}}"
"""

[tasks.brew_available]
description = "brew ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
quiet = true
run = """
if ! command -v brew >/dev/null 2>&1; then
  echo "âŒ Error: brew command not found. Please install Homebrew." >&2
  exit 1
fi
"""

[tasks.test_profile]
description = "option(name=\"profile\") ã ã¨ mise ã®çµ„ã¿è¾¼ã¿ --profile ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨è¡çªã™ã‚‹ãŸã‚ä»–ã®åå‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨"
run = """
echo "PROFILE={{option(name=\"profile\", default=\"default_profile\")}}"
echo "PROF={{option(name=\"prof\", default=\"default_prof\")}}"
"""

[tasks.check]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
if [ -z "$PROFILE" ]; then
  echo "âŒ Error: DEFAULT_PROFILE is not set in environment variables" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

echo "Checking profile path: $PROFILE_PATH"
if [ ! -d "$PROFILE_PATH" ]; then
  {
    echo "âŒ Error: Profile directory '$PROFILE_PATH' does not exist"
    echo "   Available profiles:"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      echo "   (No profiles directory found)"
    fi
  } >&2
  exit 1
fi
echo "âœ… Profile $PROFILE exists"
"""

[tasks.dump]
description = "ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ (Usage: mise run dump --prof <profile-name>)"
depends = ["brew_available"]
run = """
PROFILE={{arg(name="prof")}}
if [ -z "$PROFILE" ]; then
  {
    echo "âŒ Error: profile name is required."
    echo "   Usage: mise run dump --prof <profile-name>"
    } >&2
  exit 1
fi
echo "ğŸ¦„ Dumping current brew packages to profile: $PROFILE"
mkdir -p "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
brew bundle dump --file="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}" --force
echo "âœ… Dumped current packages to {{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
"""

[tasks.status]
description = "ç¾åœ¨ã®Brewfileã¨å®Ÿéš›ã®PCã®çŠ¶æ…‹ã®å·®åˆ†ã‚’ç¢ºèªã—ã€å·®åˆ†ãŒã‚ã‚‹å ´åˆã¯syncã‚’ä¿ƒã™"
depends = ["brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
echo "ğŸ¦„ Checking brew sync status for profile: $PROFILE"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi
echo "ğŸ¦„ Checking packages in $BREWFILE_PATH"
if brew bundle check --file="$BREWFILE_PATH"; then
  echo "âœ… All packages are in sync"
else
  {
    echo "âš ï¸ Some packages are not installed or up to date"
    echo ""
     echo "Run 'mise run sync --prof \"$PROFILE\"' to synchronize packages"
  } >&2
  exit 1
fi
"""

[tasks.sync]
description = "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®Brewfileã«åŸºã¥ã„ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã€PCã«ã‚ã‚‹ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã•ã‚Œã¦ã„ãªã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½è¨˜"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi

echo "\nğŸ¦„ Installing and Updating packages from $BREWFILE_PATH"
brew bundle install --file="$BREWFILE_PATH"

echo "\nğŸ¦„ Adding missing packages to $BREWFILE_PATH"
brew bundle dump --file="$BREWFILE_PATH" --force

echo "âœ… Sync complete!"
"""
