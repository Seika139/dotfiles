[tasks.check_env]
description = "ç’°å¢ƒå¤‰æ•°ãŒã¡ã‚ƒã‚“ã¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹"
quiet = true
hide = true
run = """
set -eu
if [ ! -e "{{env.MISE_CONFIG_ROOT}}/mise.local.toml" ]; then
  {
    printf '[env]\n'
    printf 'PROFILES_DIR="profiles"\n'
    printf 'BREWFILE_NAME="Brewfile"\n'
    printf 'DEFAULT_PROFILE=""\n'
  } > "{{env.MISE_CONFIG_ROOT}}/mise.local.toml"
  printf "ğŸš¨ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\n"
  printf "ğŸš¨ å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\n"
  printf "ğŸš¨ DEFAULT_PROFILE=\"\" ã«é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\n"
  exit 1
fi
if [ -z "${DEFAULT_PROFILE:-}" ]; then
  printf "ğŸš¨ 'DEFAULT_PROFILE' ã‚’ '{{env.MISE_CONFIG_ROOT}}/mise.local.toml' ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚\n"
  exit 1
fi
"""

[tasks.brew_available]
description = "brew ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
quiet = true
hide = true
run = """
if ! command -v brew >/dev/null 2>&1; then
  printf "âŒ Error: brew command not found. Please install Homebrew.\n" >&2
  exit 1
fi
"""

[tasks.test_profile]
description = "option(name=\"profile\") ã ã¨ mise ã®çµ„ã¿è¾¼ã¿ --profile ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨è¡çªã™ã‚‹ãŸã‚ä»–ã®åå‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨"
hide = true
quiet = true
run = """
printf "PROFILE={{option(name=\"profile\", default=\"default_profile\")}}\n"
printf "PROF={{option(name=\"prof\", default=\"default_prof\")}}\n"
"""

[tasks.check]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
depends = ["check_env"]
hide = true
quiet = true
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
if [ -z "$PROFILE" ]; then
  printf "âŒ Error: DEFAULT_PROFILE is not set in environment variables\n" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

# æˆåŠŸæ™‚ã¯ç„¡éŸ³ã€ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹
if [ ! -d "$PROFILE_PATH" ]; then
  {
    printf "âŒ Error: Profile directory '$PROFILE_PATH' does not exist\n"
    printf "   Available profiles:\n"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      printf "   (No profiles directory found)\n"
    fi
  } >&2
  exit 1
fi
"""

[tasks.dump]
description = "ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ (Usage: mise run dump <profile-name>)"
depends = ["check_env", "brew_available"]
run = """
PROFILE={{arg(name="prof")}}
if [ -z "$PROFILE" ]; then
  {
    echo "âŒ Error: profile name is required."
    echo "   Usage: mise run dump <profile-name>"
    } >&2
  exit 1
fi
echo "ğŸ¦„ Dumping current brew packages to profile: $PROFILE"
mkdir -p "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
brew bundle dump --file="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}" --force
echo "âœ… Dumped current packages to {{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
"""

[tasks.status_simple]
description = "ç¾åœ¨ã®Brewfileã¨å®Ÿéš›ã®PCã®çŠ¶æ…‹ã®å·®åˆ†ã‚’ç¢ºèªã—ã€å·®åˆ†ãŒã‚ã‚‹å ´åˆã¯syncã‚’ä¿ƒã™ï¼ˆstatusã®ç°¡æ˜“ç‰ˆï¼‰"
depends = ["check_env", "brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  printf "âŒ Error: Brewfile not found at '$BREWFILE_PATH'\n" >&2
  exit 1
fi
printf "ğŸ¦„ Checking packages in $BREWFILE_PATH\n"
if brew bundle check --file="$BREWFILE_PATH"; then
  printf "âœ… All packages are in sync\n"
else
  {
    printf "âš ï¸ Some packages are not installed or up to date\n"
    printf "Run 'mise run sync --prof \"$PROFILE\"' to synchronize packages\n"
  } >&2
  exit 1
fi
"""

[tasks.status]
description = "Brewfileã«åŸºã¥ãã€æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/è¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹"
depends = ["check_env", "brew_available"]
run = """
# POSIX å®‰å…¨è¨­å®š
set -eu
# bash ã®ã¨ãã ã‘ pipefail ã‚’æœ‰åŠ¹åŒ–
if [ -n "${BASH_VERSION:-}" ]; then set -o pipefail; fi

# ä½¿ã„æ¨ã¦ã®ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆçµ‚äº†æ™‚ã«ã¾ã¨ã‚ã¦å‰Šé™¤ï¼‰
TMP_DIR="$(mktemp -d 2>/dev/null || mktemp -d -t mise)"
cleanup(){ rm -rf "$TMP_DIR"; }
trap cleanup EXIT

make_tmp(){ mktemp "$TMP_DIR/tmp.XXXXXX"; }

PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"

BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  printf "âŒ Error: Brewfile not found at '$BREWFILE_PATH'\n" >&2
  exit 1
fi

printf "ğŸ¦„ Target Brewfile:\\033[36m $BREWFILE_PATH\\033[0m\n\n"

# ===== æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆBrewfileã«ã¯ã‚ã‚‹ãŒå…¥ã£ã¦ã„ãªã„ï¼‰ =====
printf "ğŸ“¦ Missing (Brewfileã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰\n"

# brews (formula)
TMP_WANT=$(make_tmp); TMP_HAVE=$(make_tmp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --brews 2>/dev/null | sort -u > "$TMP_WANT"
LC_ALL=C brew list --formula 2>/dev/null | sort -u > "$TMP_HAVE"
MISSING_BREWS=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)

# casks
TMP_WANT=$(make_tmp); TMP_HAVE=$(make_tmp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --casks 2>/dev/null | sort -u > "$TMP_WANT"
LC_ALL=C brew list --cask    2>/dev/null | sort -u > "$TMP_HAVE"
MISSING_CASK=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)

# taps
TMP_WANT=$(make_tmp); TMP_HAVE=$(make_tmp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --taps 2>/dev/null | sort -u > "$TMP_WANT"
LC_ALL=C brew tap               2>/dev/null | sort -u > "$TMP_HAVE"
MISSING_TAP=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)

# mas (ä»»æ„)
if command -v mas >/dev/null 2>&1; then
  TMP_WANT=$(make_tmp); TMP_HAVE=$(make_tmp)
  # Brewfile ã«è¨˜è¼‰ã® mas ã‚¢ãƒ—ãƒªIDä¸€è¦§ï¼ˆå…ˆé ­ã®IDï¼‰
  LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --mas 2>/dev/null | awk '{print $1}' | sort -u > "$TMP_WANT"
  # ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã® mas ã‚¢ãƒ—ãƒªIDä¸€è¦§
  LC_ALL=C mas list 2>/dev/null | awk '{print $1}' | sort -u > "$TMP_HAVE"
  MISSING_MAS=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)
fi

if [ -z "${MISSING_BREWS}${MISSING_CASK}${MISSING_TAP}${MISSING_MAS:-}" ]; then
  echo "  (none)"
else
  [ -n "$MISSING_TAP"   ] && { echo "  Taps:";    printf "\\033[33m$MISSING_TAP\\033[0m"   | sed 's/^/    - /'; }
  [ -n "$MISSING_BREWS" ] && { echo "  Brews:";   printf "\\033[33m$MISSING_BREWS\\033[0m" | sed 's/^/    - /'; }
  [ -n "$MISSING_CASK"  ] && { echo "  Casks:";   printf "\\033[33m$MISSING_CASK\\033[0m"  | sed 's/^/    - /'; }
  [ -n "${MISSING_MAS:-}" ] && { echo "  MAS:";   printf "\\033[33m$MISSING_MAS\\033[0m"   | sed 's/^/    - /'; }
fi
printf "\n"

# ===== è¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆBrewfileã«è¼‰ã£ã¦ã„ã‚‹ã‚‚ã®ã«é™å®šï¼‰ =====
# Brewfileã«è¨˜è¼‰ã®ã‚»ãƒƒãƒˆï¼ˆã‚ã¨ã§ãƒ•ã‚£ãƒ«ã‚¿ã«ä½¿ç”¨ï¼‰
TMP_WANT_BREWS=$(make_tmp)
TMP_WANT_CASKS=$(make_tmp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --brews  2>/dev/null | sort -u > "$TMP_WANT_BREWS"
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --casks  2>/dev/null | sort -u > "$TMP_WANT_CASKS"

OUTDATED_FORMULA_RAW=$(LC_ALL=C brew outdated --formula --verbose 2>/dev/null || true)
OUTDATED_CASK_RAW=$(LC_ALL=C brew outdated --cask --greedy 2>/dev/null || true)

# 1åˆ—ç›®ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼‰ã‚’æŠ½å‡ºã—ã¦ Brewfile è¨˜è¼‰åˆ†ã ã‘ã«çµã‚‹
OUTDATED_FORMULA=$(
  echo "$OUTDATED_FORMULA_RAW" | awk '{print $1}' | LC_ALL=C grep -Fxf "$TMP_WANT_BREWS" || true
)
OUTDATED_CASK=$(
  echo "$OUTDATED_CASK_RAW"    | awk '{print $1}' | LC_ALL=C grep -Fxf "$TMP_WANT_CASKS" || true
)

echo "ğŸ”„ Outdated (ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸)"
if [ -z "${OUTDATED_FORMULA}${OUTDATED_CASK}" ]; then
  echo "  (none)"
else
  [ -n "$OUTDATED_FORMULA" ] && { echo "  Formula:"; printf "\\033[33m$OUTDATED_FORMULA\\033[0m\n" | sed 's/^/    - /'; }
  [ -n "$OUTDATED_CASK"    ] && { echo "  Casks:";   printf "\\033[33m$OUTDATED_CASK\\033[0m\n"    | sed 's/^/    - /'; }
fi
printf "\n"

# ===== ã‚µãƒãƒª & çµ‚äº†ã‚³ãƒ¼ãƒ‰ =====
missing_count=$(
  printf "%s\n%s\n%s\n%s\n" \
    "${MISSING_TAP:-}" "${MISSING_BREWS:-}" "${MISSING_CASK:-}" "${MISSING_MAS:-}" \
    | sed '/^$/d' | wc -l | awk '{print $1}'
)
outdated_count=$(
  printf "%s\n%s\n" "${OUTDATED_FORMULA:-}" "${OUTDATED_CASK:-}" \
    | sed '/^$/d' | wc -l | awk '{print $1}'
)

printf "ğŸ“Š Summary: missing=${missing_count}, outdated=${outdated_count}\n"
printf "  - Install/upgrade ã‚’å®Ÿè¡Œã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€:\\033[36m mise run sync --prof \"$PROFILE\"\\033[36m\n"
printf "  - Brewfileã«è¨˜è¼‰ãŒãªã„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèª:\\033[36m mise run prune --prof \"$PROFILE\"\\033[36m\n"
printf "  - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å˜ä½“ã§æ›´æ–°ã™ã‚‹å ´åˆã¯\\033[36m brew upgrade (--cask) <package-name>\\033[0m\n"


# Missing ã¾ãŸã¯ Outdated ãŒã‚ã‚Œã° 1 ã‚’è¿”ã™ï¼ˆâ€œè¦å¯¾å¿œâ€ ã‚’çµ‚äº†ã‚³ãƒ¼ãƒ‰ã§ç¤ºã™ï¼‰
if [ "$missing_count" -gt 0 ] || [ "$outdated_count" -gt 0 ]; then
  exit 1
fi
"""

[tasks.sync]
description = "Brewfileã«åŸºã¥ã„ã¦ install + upgrade ã‚’å®Ÿè¡Œï¼ˆBrewfileã«å¤‰æ›´ã¯åŠ ãˆã¾ã›ã‚“ï¼‰ã€‚--greedy ã§caskã®ç©æ¥µçš„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’å®Ÿæ–½ã—ã¾ã™"
depends = ["check_env", "brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  printf "âŒ Error: Brewfile not found at '$BREWFILE_PATH'\n" >&2
  exit 1
fi

printf "ğŸ¦„ Sync: install + upgrade by Brewfile\n"
brew update
# --greedy ãŒæŒ‡å®šã•ã‚ŒãŸã‚‰ã€auto_updatesç­‰ã‚‚å«ã‚ã¦caskã‚’ç©æ¥µã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
if {{flag(name="greedy")}}; then
  printf "ğŸ§ª Greedy upgrade for casks (including auto_updates)\n"
  brew upgrade --cask --greedy
fi
brew bundle install --file="$BREWFILE_PATH"

printf "\nâœ… Sync complete!\n"
printf "Brewfileã§ç®¡ç†ã•ã‚Œã¦ã„ãªã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã¯: mise run prune --prof \"$PROFILE\"\n"
"""

[tasks.prune]
description = "Brewfile ã«ç„¡ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ dry-runã€‚--apply ã§å‰Šé™¤ã‚’å®Ÿè¡Œï¼‰"
depends = ["check_env", "brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  print "âŒ Error: Brewfile not found at '$BREWFILE_PATH'\n" >&2
  exit 1
fi

if {{flag(name="apply")}}; then
  mise run prune_apply -y --prof "$PROFILE"
else
  print "ğŸ¦„ Dry-run: List packages NOT in $BREWFILE_PATH\n"

  TMP_OUT=$(mktemp)
  trap 'rm -f "$TMP_OUT"' EXIT
  brew bundle cleanup --file="$BREWFILE_PATH" 2>&1 | tee "$TMP_OUT"

  COUNTS=$(
    awk '
      /^Would uninstall formulae:/ {section="form"; next}
      /^Would uninstall casks:/    {section="cask"; next}
      /^Would uninstall taps:/     {section="tap"; next}
      /^Would uninstall / || /^Run `brew bundle cleanup/ { if (section) section="" }
      section && NF {counts[section]++}
      END {
        print counts["form"]+0
        print counts["cask"]+0
        print counts["tap"]+0
      }
    ' "$TMP_OUT"
  )

  FORM_COUNT=$(echo "$COUNTS" | sed -n 1p)
  CASK_COUNT=$(echo "$COUNTS" | sed -n 2p)
  TAP_COUNT=$(echo "$COUNTS" | sed -n 3p)

  if [ "$TAP_COUNT" -eq 0 ]; then
    TAP_COUNT=$(grep -c '^Would untap ' "$TMP_OUT" || true)
  fi

  TOTAL=$((FORM_COUNT + CASK_COUNT + TAP_COUNT))

  if [ "$TOTAL" -gt 0 ]; then
    printf "\nâš ï¸ å‰Šé™¤å€™è£œãŒã‚ã‚Šã¾ã™ï¼ˆformulae=${FORM_COUNT}, casks=${CASK_COUNT}, taps=${TAP_COUNT} / total=${TOTAL}ï¼‰\n"
    printf "   å®Ÿè¡Œã™ã‚‹ã«ã¯: mise run prune --apply --prof \"$PROFILE\"\n"
    exit 1
  else
    printf "\nâœ… å‰Šé™¤å€™è£œã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆBrewfile ã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ï¼‰\n"
  fi
fi
"""

[tasks.prune_apply]
description = "Brewfile ã«ç„¡ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆæœ¬é©ç”¨ï¼‰"
hide = true
depends = ["check_env", "brew_available"]
confirm = "é¸æŠã—ãŸBrewfileã«è¨˜è¼‰ã®ãªã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  printf "âŒ Error: Brewfile not found at '$BREWFILE_PATH'\n" >&2
  exit 1
fi

printf "ğŸ¦„ Uninstalling packages NOT listed in $BREWFILE_PATH\n"
brew bundle cleanup --file="$BREWFILE_PATH" --force

# ï¼ˆä»»æ„ï¼‰ä¾å­˜é–¢ä¿‚ã¨ã—ã¦ä¸è¦ã«ãªã£ãŸãƒ•ã‚©ãƒ¼ãƒŸãƒ¥ãƒ©ã®è‡ªå‹•å‰Šé™¤
# brew autoremove

printf "âœ… Prune complete!\n"
"""
