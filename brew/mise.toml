# ç’°å¢ƒå¤‰æ•°ã®å®šç¾©
[env]
PROFILES_DIR = "profiles"
BREWFILE_NAME = "Brewfile"
DEFAULT_PROFILE = "hm-m1-mac"

[tasks.vars]
description = "å¤‰æ•°ã®å€¤ã‚’è¡¨ç¤º"
quiet = true
run = """
echo "PROFILES_DIR    = {{env.PROFILES_DIR}}"
echo "BREWFILE_NAME   = {{env.BREWFILE_NAME}}"
echo "DEFAULT_PROFILE = {{env.DEFAULT_PROFILE}}"
"""

[tasks.brew_available]
description = "brew ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
quiet = true
run = """
if ! command -v brew >/dev/null 2>&1; then
  echo "âŒ Error: brew command not found. Please install Homebrew." >&2
  exit 1
fi
"""

[tasks.test_profile]
description = "option(name=\"profile\") ã ã¨ mise ã®çµ„ã¿è¾¼ã¿ --profile ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨è¡çªã™ã‚‹ãŸã‚ä»–ã®åå‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨"
run = """
echo "PROFILE={{option(name=\"profile\", default=\"default_profile\")}}"
echo "PROF={{option(name=\"prof\", default=\"default_prof\")}}"
"""

[tasks.check]
description = "æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
if [ -z "$PROFILE" ]; then
  echo "âŒ Error: DEFAULT_PROFILE is not set in environment variables" >&2
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"

echo "Checking profile path: $PROFILE_PATH"
if [ ! -d "$PROFILE_PATH" ]; then
  {
    echo "âŒ Error: Profile directory '$PROFILE_PATH' does not exist"
    echo "   Available profiles:"
    if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
      ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
    else
      echo "   (No profiles directory found)"
    fi
  } >&2
  exit 1
fi
echo "âœ… Profile $PROFILE exists"
"""

[tasks.dump]
description = "ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ (Usage: mise run dump --prof <profile-name>)"
depends = ["brew_available"]
run = """
PROFILE={{arg(name="prof")}}
if [ -z "$PROFILE" ]; then
  {
    echo "âŒ Error: profile name is required."
    echo "   Usage: mise run dump --prof <profile-name>"
    } >&2
  exit 1
fi
echo "ğŸ¦„ Dumping current brew packages to profile: $PROFILE"
mkdir -p "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
brew bundle dump --file="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}" --force
echo "âœ… Dumped current packages to {{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
"""

[tasks.status_simple]
description = "ç¾åœ¨ã®Brewfileã¨å®Ÿéš›ã®PCã®çŠ¶æ…‹ã®å·®åˆ†ã‚’ç¢ºèªã—ã€å·®åˆ†ãŒã‚ã‚‹å ´åˆã¯syncã‚’ä¿ƒã™ï¼ˆstatusã®ç°¡æ˜“ç‰ˆï¼‰"
depends = ["brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
echo "ğŸ¦„ Checking brew sync status for profile: $PROFILE"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi
echo "ğŸ¦„ Checking packages in $BREWFILE_PATH"
if brew bundle check --file="$BREWFILE_PATH"; then
  echo "âœ… All packages are in sync"
else
  {
    echo "âš ï¸ Some packages are not installed or up to date"
    echo ""
    echo "Run 'mise run sync --prof \"$PROFILE\"' to synchronize packages"
  } >&2
  exit 1
fi
"""

[tasks.status]
description = "Brewfileã«åŸºã¥ãã€æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/è¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹"
depends = ["brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"

BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi

echo "ğŸ¦„ Target Brewfile: $BREWFILE_PATH"
echo ""

# ===== æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆBrewfileã«ã¯ã‚ã‚‹ãŒå…¥ã£ã¦ã„ãªã„ï¼‰ =====
echo "ğŸ“¦ Missing (Brewfileã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰"

# brews (formula)
TMP_WANT=$(mktemp); TMP_HAVE=$(mktemp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --brews  2>/dev/null | sort -u > "$TMP_WANT"
LC_ALL=C brew list --formula 2>/dev/null | sort -u > "$TMP_HAVE"
MISSING_BREWS=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)
rm -f "$TMP_WANT" "$TMP_HAVE"

# casks
TMP_WANT=$(mktemp); TMP_HAVE=$(mktemp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --casks  2>/dev/null | sort -u > "$TMP_WANT"
LC_ALL=C brew list --cask    2>/dev/null | sort -u > "$TMP_HAVE"
MISSING_CASK=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)
rm -f "$TMP_WANT" "$TMP_HAVE"

# taps
TMP_WANT=$(mktemp); TMP_HAVE=$(mktemp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --taps   2>/dev/null | sort -u > "$TMP_WANT"
LC_ALL=C brew tap               2>/dev/null | sort -u > "$TMP_HAVE"
MISSING_TAP=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)
rm -f "$TMP_WANT" "$TMP_HAVE"

# mas (ä»»æ„)
if command -v mas >/dev/null 2>&1; then
  TMP_WANT=$(mktemp); TMP_HAVE=$(mktemp)
  # Brewfile ã«è¨˜è¼‰ã® mas ã‚¢ãƒ—ãƒªIDä¸€è¦§ï¼ˆå…ˆé ­ã®IDï¼‰
  LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --mas 2>/dev/null | awk '{print $1}' | sort -u > "$TMP_WANT"
  # ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã® mas ã‚¢ãƒ—ãƒªIDä¸€è¦§
  LC_ALL=C mas list 2>/dev/null | awk '{print $1}' | sort -u > "$TMP_HAVE"
  MISSING_MAS=$(LC_ALL=C comm -23 "$TMP_WANT" "$TMP_HAVE" || true)
  rm -f "$TMP_WANT" "$TMP_HAVE"
fi

if [ -z "$MISSING_BREWS$MISSING_CASK$MISSING_TAP${MISSING_MAS:-}" ]; then
  echo "  (none)"
else
  [ -n "$MISSING_TAP"   ] && { echo "  Taps:";    echo "$MISSING_TAP"    | sed 's/^/    - /'; }
  [ -n "$MISSING_BREWS" ] && { echo "  Brews:";   echo "$MISSING_BREWS"  | sed 's/^/    - /'; }
  [ -n "$MISSING_CASK"  ] && { echo "  Casks:";   echo "$MISSING_CASK"   | sed 's/^/    - /'; }
  [ -n "${MISSING_MAS:-}" ] && { echo "  MAS:";   echo "$MISSING_MAS"    | sed 's/^/    - /'; }
fi
echo ""

# ===== è¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆBrewfileã«è¼‰ã£ã¦ã„ã‚‹ã‚‚ã®ã«é™å®šï¼‰ =====
# Brewfileã«è¨˜è¼‰ã®ã‚»ãƒƒãƒˆï¼ˆã‚ã¨ã§ãƒ•ã‚£ãƒ«ã‚¿ã«ä½¿ç”¨ï¼‰
TMP_WANT_BREWS=$(mktemp)
TMP_WANT_CASKS=$(mktemp)
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --brews  2>/dev/null | sort -u > "$TMP_WANT_BREWS"
LC_ALL=C brew bundle list --file="$BREWFILE_PATH" --casks  2>/dev/null | sort -u > "$TMP_WANT_CASKS"

OUTDATED_FORMULA_RAW=$(brew outdated --formula --verbose 2>/dev/null || true)
OUTDATED_CASK_RAW=$(brew outdated --cask --greedy 2>/dev/null || true)

# 1åˆ—ç›®ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼‰ã‚’æŠ½å‡ºã—ã¦ Brewfile è¨˜è¼‰åˆ†ã ã‘ã«çµã‚‹
OUTDATED_FORMULA=$(
  echo "$OUTDATED_FORMULA_RAW" | awk '{print $1}' | LC_ALL=C grep -Fxf "$TMP_WANT_BREWS" || true
)
OUTDATED_CASK=$(
  echo "$OUTDATED_CASK_RAW"    | awk '{print $1}' | LC_ALL=C grep -Fxf "$TMP_WANT_CASKS" || true
)

rm -f "$TMP_WANT_BREWS" "$TMP_WANT_CASKS"

echo "ğŸ”„ Outdated (ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸)"
if [ -z "$OUTDATED_FORMULA$OUTDATED_CASK" ]; then
  echo "  (none)"
else
  [ -n "$OUTDATED_FORMULA" ] && { echo "  Formula:"; printf "%s\n" "$OUTDATED_FORMULA" | sed 's/^/    - /'; }
  [ -n "$OUTDATED_CASK"    ] && { echo "  Casks:";   printf "%s\n" "$OUTDATED_CASK"    | sed 's/^/    - /'; }
fi

echo ""

# ===== ã‚µãƒãƒª & çµ‚äº†ã‚³ãƒ¼ãƒ‰ =====
missing_count=$(
  printf "%s\n%s\n%s\n%s\n" \
    "$MISSING_TAP" "$MISSING_BREWS" "$MISSING_CASK" "${MISSING_MAS:-}" \
    | sed '/^$/d' | wc -l | awk '{print $1}'
)
outdated_count=$(
  printf "%s\n%s\n" "$OUTDATED_FORMULA" "$OUTDATED_CASK" \
    | sed '/^$/d' | wc -l | awk '{print $1}'
)

echo "ğŸ“Š Summary: missing=${missing_count}, outdated=${outdated_count}"
echo "ğŸ’¡ Install/upgrade ã‚’å®Ÿè¡Œã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€: mise run sync --prof \"$PROFILE\""
echo "ğŸ§¹ Brewfileã«è¨˜è¼‰ãŒãªã„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèª: mise run prune_dry_run --prof \"$PROFILE\""


# Missing ã¾ãŸã¯ Outdated ãŒã‚ã‚Œã° 1 ã‚’è¿”ã™ï¼ˆâ€œè¦å¯¾å¿œâ€ ã‚’çµ‚äº†ã‚³ãƒ¼ãƒ‰ã§ç¤ºã™ï¼‰
if [ "$missing_count" -gt 0 ] || [ "$outdated_count" -gt 0 ]; then
  exit 1
fi
"""

[tasks.sync]
description = "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®Brewfileã«åŸºã¥ã„ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼†ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã€Brewfileã‚’æœ€æ–°åŒ–"
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi

echo ""
echo "ğŸ¦„ Installing missing packages from $BREWFILE_PATH"
brew bundle install --file="$BREWFILE_PATH"

echo ""
echo "ğŸ¦„ Upgrading existing packages"
brew upgrade --formula
brew upgrade --cask --greedy

brew bundle list --file="$BREWFILE_PATH" --brews | xargs brew upgrade
brew bundle list --file="$BREWFILE_PATH" --casks | xargs brew upgrade --cask --greedy

# formula ã®å ´åˆï¼ˆBrewfile âˆ© ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼‰
comm -12 \
  <(brew bundle list --file="$BREWFILE_PATH" --brews | sort) \
  <(brew list --formula | sort) \
  | xargs brew upgrade || true

# cask ã®å ´åˆï¼ˆBrewfile âˆ© ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼‰
comm -12 \
  <(brew bundle list --file="$BREWFILE_PATH" --casks | sort) \
  <(brew list --cask | sort) \
  | xargs brew upgrade --cask --greedy || true


echo ""
echo "ğŸ¦„ Refreshing Brewfile (add newly installed packages)"
brew bundle dump --file="$BREWFILE_PATH" --force

echo "âœ… Sync complete!"
"""

[tasks.prune_dry_run]
description = "Brewfile ã«ç„¡ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å€™è£œã‚’ç¢ºèªï¼ˆã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã—ãªã„ï¼‰"
depends = ["brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi

echo "ğŸ¦„ Dry-run: packages not in $BREWFILE_PATH (nothing will be uninstalled)"
brew bundle cleanup --file="$BREWFILE_PATH"
echo ""
echo "â€» ä¸Šè¨˜ãŒã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å€™è£œã§ã™ã€‚å®Ÿè¡Œã™ã‚‹ã«ã¯ 'mise run prune --prof \"$PROFILE\"' ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"
"""

[tasks.prune]
description = "Brewfile ã«ç„¡ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸€æ‹¬ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆä¸å¯é€†æ“ä½œï¼‰"
depends = ["brew_available"]
run = """
PROFILE={{option(name="prof", default=env.DEFAULT_PROFILE)}}
mise run check --prof "$PROFILE"
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "âŒ Error: Brewfile not found at '$BREWFILE_PATH'" >&2
  exit 1
fi

echo "ğŸ¦„ Uninstalling packages NOT listed in $BREWFILE_PATH"
brew bundle cleanup --file="$BREWFILE_PATH" --force
echo "âœ… Prune complete!"
"""
