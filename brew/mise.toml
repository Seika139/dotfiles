# 環境変数の定義
[env]
PROFILES_DIR = "profiles"
BREWFILE_NAME = "Brewfile"
DEFAULT_PROFILE = "hm-m1-mac"

[tasks.vars]
description = "変数の値を表示"
quiet = true
run = """
echo "PROFILES_DIR    = {{env.PROFILES_DIR}}"
echo "BREWFILE_NAME   = {{env.BREWFILE_NAME}}"
echo "DEFAULT_PROFILE = {{env.DEFAULT_PROFILE}}"
"""

[tasks.check]
description = "{{env.DEFAULT_PROFILE}} が存在するかを確認し、なければエラーを返す"
run = """
if [ -z "{{env.DEFAULT_PROFILE}}" ]; then
  echo "❌ Error:{{env.DEFAULT_PROFILE}} is not set in environment variables"
  exit 1
fi

PROFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/{{env.DEFAULT_PROFILE}}"

echo "Checking profile path: $PROFILE_PATH"
if [ ! -d "$PROFILE_PATH" ]; then
  echo "❌ Error: Default profile directory '$PROFILE_PATH' does not exist"
  echo "   Available profiles:"
  if [ -d "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" ]; then
    ls -1 "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}" | sed 's/^/   - /'
  else
    echo "   (No profiles directory found)"
  fi
  exit 1
fi
echo "✅ Default profile '{{env.DEFAULT_PROFILE}}' exists"
"""

[tasks.dump]
description = "現在インストールされているパッケージをプロファイルに書き出す (Usage: mise run dump --profile <profile-name>)"
run = """
PROFILE={{arg(name="profile")}}
if [ -z "$PROFILE" ]; then
  echo "❌ Error: profile name is required."
  echo "   Usage: mise run dump --profile <profile-name>"
  exit 1
fi
echo "🦄 Dumping current brew packages to profile: $PROFILE"
mkdir -p "{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE"
brew bundle dump --file="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}" --force
echo "✅ Dumped current packages to {{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
"""

[tasks.status]
description = "現在のBrewfileと実際のPCの状態の差分を確認し、差分がある場合はsyncを促す"
depends = ["check"]
run = """
PROFILE={{option(name="profile", default=env.DEFAULT_PROFILE)}}
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
echo "🦄 Checking brew sync status for profile: $PROFILE"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "❌ Error: Brewfile not found at '$BREWFILE_PATH'"
  exit 1
fi
echo "🦄 Checking packages in $BREWFILE_PATH"
if brew bundle check --file="$BREWFILE_PATH"; then
  echo "✅ All packages are in sync"
else
  echo "⚠️ Some packages are not installed or up to date"
  echo ""
  echo "Run 'mise run sync' to synchronize packages"
  exit 1
fi
"""

[tasks.sync]
description = "プロファイルのBrewfileに基づいてパッケージをインストール、アップデートし、PCにあるがファイルに書き出されていないパッケージを追記"
depends = ["check"]
run = """
PROFILE={{option(name="profile", default=env.DEFAULT_PROFILE)}}
BREWFILE_PATH="{{env.MISE_CONFIG_ROOT}}/{{env.PROFILES_DIR}}/$PROFILE/{{env.BREWFILE_NAME}}"
if [ ! -f "$BREWFILE_PATH" ]; then
  echo "❌ Error: Brewfile not found at '$BREWFILE_PATH'"
  exit 1
fi

echo "\n🦄 Installing and Updating packages from $BREWFILE_PATH"
brew bundle install --file="$BREWFILE_PATH"

echo "\n🦄 Adding missing packages to $BREWFILE_PATH"
brew bundle dump --file="$BREWFILE_PATH" --force

echo "✅ Sync complete!"
"""
